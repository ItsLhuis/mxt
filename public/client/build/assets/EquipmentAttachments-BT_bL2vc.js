import{e as I,r as g,j as t,S as n,b4 as $,b5 as P,b6 as W,h as s,aE as k,aF as C,aH as F,aI as N,aJ as R,aL as E,ag as D,aK as H,aM as U,aN as K,aO as J,H as T,aQ as Q,aR as G,B as z,aS as X,b7 as Y,aT as Z,bB as w,L as ee,f as te}from"./index-mWc9gLhA.js";import{u as V}from"./useEquipment-DvbTvh-h.js";import{V as ne}from"./Visibility-BUE77Vck.js";import{A as M}from"./Attachment-Bkxa8WLH.js";import{u as ae,t as ie,C as se}from"./index-COzNbWAj.js";import{a as le}from"./equipment-oKlO_vtn.js";const me=({equipment:l,isLoading:m,isError:o})=>{var q;const c=!m&&!o,{role:v}=I(),{deleteEquipmentAttachment:_}=V(),[r,p]=g.useState(!1),[a,u]=g.useState({url:"",name:"",size:"",type:""}),d=(e,i,j,b)=>{u({url:e,name:i,size:j,type:b}),p(!0)},x=()=>{p(!1),u({url:"",type:""})},[h,A]=g.useState({isOpen:!1,equipmentAttachment:null}),B=e=>{A({isOpen:!0,equipmentAttachment:e})},f=()=>{A({isOpen:!1,equipmentAttachment:null})},L=()=>new Promise((e,i)=>{h.equipmentAttachment?_.mutateAsync({equipmentId:h.equipmentAttachment.equipment_id,attachmentId:h.equipmentAttachment.id}).then(()=>{f(),e()}).catch(()=>{f(),i()}):(f(),i())}),O=g.useMemo(()=>[{id:"file_mime_type",label:"Tipo",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsx(n,{sx:{alignItems:"flex-start"},children:(e==null?void 0:e.file_mime_type)==="application/pdf"?t.jsx("img",{src:$}):e!=null&&e.file_mime_type.startsWith("image/")?t.jsx("img",{src:P}):t.jsx("img",{src:W})})},{id:"original_filename",label:"Ficheiro",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsxs(n,{children:[t.jsx(s,{variant:"p",component:"p",children:e==null?void 0:e.original_filename}),t.jsx(s,{variant:"p",component:"p",sx:{color:"var(--outline)"},children:`${(e==null?void 0:e.file_size)<1024*1024?((e==null?void 0:e.file_size)/1024).toFixed(2)+" Kb":((e==null?void 0:e.file_size)/(1024*1024)).toFixed(2)+" Mb"}`})]})},{id:"uploaded_by_user",visible:!1},{id:"uploaded_at_datetime",label:"Carregado por",align:"left",sortable:!0,renderComponent:({row:e})=>{var i,j,b,y,S;return t.jsx(t.Fragment,{children:t.jsxs(n,{sx:{flexDirection:"row",gap:2},children:[t.jsx(n,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:e!=null&&e.uploaded_by_user?t.jsxs(t.Fragment,{children:[t.jsx(k,{alt:(i=e==null?void 0:e.uploaded_by_user)==null?void 0:i.username,src:`${C}/users/${(j=e==null?void 0:e.uploaded_by_user)==null?void 0:j.id}/avatar?size=80`,name:(b=e==null?void 0:e.uploaded_by_user)==null?void 0:b.username}),t.jsxs(n,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:(y=e==null?void 0:e.uploaded_by_user)==null?void 0:y.username}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:(S=e==null?void 0:e.uploaded_by_user)==null?void 0:S.role})]})]}):t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),t.jsx(F,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsxs(n,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:N(e==null?void 0:e.uploaded_at_datetime)}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:R(e==null?void 0:e.uploaded_at_datetime)})]})]})})}},{id:"view_file",align:"right",sortable:!1,renderComponent:({row:e})=>t.jsx(E,{title:"Ver anexo",sx:{margin:-1},children:t.jsx(D,{onClick:()=>d(`${C}/equipments/${e==null?void 0:e.equipment_id}/attachments/${e==null?void 0:e.id}/${e==null?void 0:e.original_filename}`,e==null?void 0:e.original_filename,e==null?void 0:e.file_size,e==null?void 0:e.file_mime_type),children:t.jsx(ne,{})})})},{id:"more_options",align:"right",sortable:!1,disablePadding:!0,renderComponent:({row:e})=>{if(v!=="Funcionário")return t.jsx(H,{mode:"custom",customButton:t.jsx(E,{title:"Mais opções",sx:{margin:-1},children:t.jsx(D,{children:t.jsx(U,{})})}),children:t.jsx(K,{buttons:[{label:"Eliminar",icon:t.jsx(J,{fontSize:"small",color:"error"}),color:"error",onClick:()=>B(e)}]})})}}],[]);return t.jsxs(n,{children:[t.jsx(T,{title:"Anexos",description:"Anexos do equipamento",icon:t.jsx(M,{})}),t.jsx(Q,{isLoading:!c,LoadingComponent:t.jsx(G,{mode:"datatable"}),LoadedComponent:t.jsx(z,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:t.jsx(X,{mode:"datatable",data:c?(q=l[0])==null?void 0:q.attachments:[],columns:O})})}),t.jsx(F,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsx(Y,{open:r,onClose:x,file:a.url,fileName:a.name,fileSize:Number(a.size),fileType:a.type}),t.jsx(Z,{mode:"delete",title:"Eliminar Anexo",open:h.isOpen,onClose:f,onSubmit:L,description:"Tem a certeza que deseja eliminar este anexo?",subDescription:"Ao eliminar este anexo, os dados serão removidos de forma permanente."})]})},oe=({equipment:l,isLoading:m,isError:o})=>{const c=!m&&!o,{control:v,handleSubmit:_,formState:{errors:r},reset:p}=ae({resolver:ie(le),defaultValues:{attachments:[]}}),{addNewEquipmentAttachment:a}=V(),u=async d=>{c&&await a.mutateAsync({equipmentId:l[0].id,...d}).then(()=>p())};return t.jsxs(n,{children:[t.jsx(T,{title:"Anexos",description:"Adicionar novos anexos ao equipamento",icon:t.jsx(M,{})}),t.jsx("form",{onSubmit:_(u),children:t.jsxs(n,{sx:{padding:3,gap:3},children:[t.jsx(se,{name:"attachments",control:v,defaultValue:"",render:({field:d})=>{var x;return t.jsx(w,{disabled:a.isPending,value:d.value,onChange:d.onChange,error:!!r.attachments,helperText:(x=r.attachments)==null?void 0:x.message})}}),t.jsx(z,{sx:{marginLeft:"auto"},children:t.jsx(ee,{loading:a.isPending,type:"submit",variant:"contained",disabled:!c,children:"Adicionar Anexos"})})]})})]})},he=({equipment:l,isLoading:m,isError:o})=>t.jsxs(te,{elevation:1,children:[t.jsx(me,{equipment:l,isLoading:m,isError:o}),t.jsx(oe,{equipment:l,isLoading:m,isError:o})]});export{he as default};
