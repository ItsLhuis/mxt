import{e as $,r as g,j as t,S as a,be as P,bf as E,bg as W,h as s,aZ as k,a_ as F,a$ as R,aE as H,aF as N,aH as D,aj as z,ax as U,ay as q,b0 as K,H as M,aM as Z,b1 as G,B as T,aC as J,bh as Q,b2 as X,bI as Y,L as w,f as ee}from"./index-C9HasOiM.js";import{u as V}from"./useRepair-Cho1bqHB.js";import{V as te}from"./Visibility-B00d3i-B.js";import{M as ae}from"./MoreVert-CDz2P5kD.js";import{A as B}from"./Attachment-ukPOh3N_.js";import{u as ie,t as ne,C as se}from"./index-BTi6rd4V.js";import{b as le}from"./repair-C13Y1Qe-.js";import"./repair-DgMqRd6F.js";const re=({repair:l,isLoading:r,isError:o})=>{var y;const m=!r&&!o,{role:_}=$(),{deleteRepairAttachment:v}=V(),[c,p]=g.useState(!1),[i,x]=g.useState({url:"",name:"",size:"",type:""}),d=(e,n,j,b)=>{x({url:e,name:n,size:j,type:b}),p(!0)},h=()=>{p(!1),x({url:"",type:""})},[u,A]=g.useState({isOpen:!1,repairAttachment:null}),I=e=>{A({isOpen:!0,repairAttachment:e})},f=()=>{A({isOpen:!1,repairAttachment:null})},L=()=>new Promise((e,n)=>{u.repairAttachment?v.mutateAsync({repairId:u.repairAttachment.repair_id,attachmentId:u.repairAttachment.id}).then(()=>{f(),e()}).catch(()=>{f(),n()}):(f(),n())}),O=g.useMemo(()=>[{id:"file_mime_type",label:"Tipo",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsx(a,{sx:{alignItems:"flex-start"},children:(e==null?void 0:e.file_mime_type)==="application/pdf"?t.jsx("img",{src:P}):e!=null&&e.file_mime_type.startsWith("image/")?t.jsx("img",{src:E}):t.jsx("img",{src:W})})},{id:"original_filename",label:"Ficheiro",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsxs(a,{children:[t.jsx(s,{variant:"p",component:"p",children:e==null?void 0:e.original_filename}),t.jsx(s,{variant:"p",component:"p",sx:{color:"var(--outline)"},children:`${(e==null?void 0:e.file_size)<1024*1024?((e==null?void 0:e.file_size)/1024).toFixed(2)+" Kb":((e==null?void 0:e.file_size)/(1024*1024)).toFixed(2)+" Mb"}`})]})},{id:"uploaded_by_user",visible:!1},{id:"uploaded_at_datetime",label:"Carregado por",align:"left",sortable:!0,renderComponent:({row:e})=>{var n,j,b,C,S;return t.jsx(t.Fragment,{children:t.jsxs(a,{sx:{flexDirection:"row",gap:2},children:[t.jsx(a,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:e!=null&&e.uploaded_by_user?t.jsxs(t.Fragment,{children:[t.jsx(k,{alt:(n=e==null?void 0:e.uploaded_by_user)==null?void 0:n.username,src:`${F}/users/${(j=e==null?void 0:e.uploaded_by_user)==null?void 0:j.id}/avatar?size=80`,name:(b=e==null?void 0:e.uploaded_by_user)==null?void 0:b.username}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:(C=e==null?void 0:e.uploaded_by_user)==null?void 0:C.username}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:(S=e==null?void 0:e.uploaded_by_user)==null?void 0:S.role})]})]}):t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:H(e==null?void 0:e.uploaded_at_datetime)}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:N(e==null?void 0:e.uploaded_at_datetime)})]})]})})}},{id:"view_file",align:"right",sortable:!1,renderComponent:({row:e})=>t.jsx(D,{title:"Ver anexo",sx:{margin:-1},children:t.jsx(z,{onClick:()=>d(`${F}/repairs/${e==null?void 0:e.repair_id}/attachments/${e==null?void 0:e.id}/${e==null?void 0:e.original_filename}`,e==null?void 0:e.original_filename,e==null?void 0:e.file_size,e==null?void 0:e.file_mime_type),children:t.jsx(te,{})})})},{id:"more_options",align:"right",sortable:!1,disablePadding:!0,renderComponent:({row:e})=>{if(_!=="Funcionário")return t.jsx(U,{mode:"custom",customButton:t.jsx(D,{title:"Mais opções",sx:{margin:-1},children:t.jsx(z,{children:t.jsx(ae,{})})}),children:t.jsx(q,{buttons:[{label:"Eliminar",icon:t.jsx(K,{fontSize:"small",color:"error"}),color:"error",onClick:()=>I(e)}]})})}}],[]);return t.jsxs(a,{children:[t.jsx(M,{title:"Anexos",description:"Anexos do equipamento",icon:t.jsx(B,{})}),t.jsx(Z,{isLoading:!m,LoadingComponent:t.jsx(G,{mode:"datatable"}),LoadedComponent:t.jsx(T,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:t.jsx(J,{mode:"datatable",data:m?(y=l[0])==null?void 0:y.attachments:[],columns:O})})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsx(Q,{open:c,onClose:h,file:i.url,fileName:i.name,fileSize:Number(i.size),fileType:i.type}),t.jsx(X,{mode:"delete",title:"Eliminar Anexo",open:u.isOpen,onClose:f,onSubmit:L,description:"Tem a certeza que deseja eliminar este anexo?",subDescription:"Ao eliminar este anexo, os dados serão removidos de forma permanente."})]})},oe=({repair:l,isLoading:r,isError:o})=>{const m=!r&&!o,{control:_,handleSubmit:v,formState:{errors:c},reset:p}=ie({resolver:ne(le),defaultValues:{attachments:[]}}),{addNewRepairAttachment:i}=V(),x=async d=>{m&&await i.mutateAsync({repairId:l[0].id,...d}).then(()=>p())};return t.jsxs(a,{children:[t.jsx(M,{title:"Anexos",description:"Adicionar novos anexos à reparação",icon:t.jsx(B,{})}),t.jsx("form",{onSubmit:v(x),children:t.jsxs(a,{sx:{padding:3,gap:3},children:[t.jsx(se,{name:"attachments",control:_,defaultValue:"",render:({field:d})=>{var h;return t.jsx(Y,{disabled:i.isPending,value:d.value,onChange:d.onChange,error:!!c.attachments,helperText:(h=c.attachments)==null?void 0:h.message})}}),t.jsx(T,{sx:{marginLeft:"auto"},children:t.jsx(w,{loading:i.isPending,type:"submit",variant:"contained",disabled:!m,children:"Adicionar Anexos"})})]})})]})},je=({repair:l,isLoading:r,isError:o})=>t.jsxs(ee,{elevation:1,children:[t.jsx(re,{repair:l,isLoading:r,isError:o}),t.jsx(oe,{repair:l,isLoading:r,isError:o})]});export{je as default};
