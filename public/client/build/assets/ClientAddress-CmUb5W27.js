import{r as T,j as e,aU as J,B as F,G as p,F as x,T as h,S as l,ak as N,s as V,e as ee,h as o,aF as B,aG as R,aI as W,aJ as U,aK as $,aL as te,aM as ae,ah as se,aN as ie,aO as le,aP as re,aQ as G,H,aR as oe,aS as de,aT as ne,b as ce,a as me,L as ue,f as pe}from"./index-_NktdslD.js";import{u as O}from"./useClient-B8aLe1Fc.js";import{u as Q,t as q,b as xe}from"./index-8QsUXVhp.js";import{b as K}from"./client-BHMlStuD.js";import{E as he}from"./Edit-9t-WI8hJ.js";import{P as X}from"./Place-Cg-rCbml.js";import"./isPossiblePhoneNumber-DES16dOz.js";const fe=({clientAddress:a,open:r,onClose:d})=>{var M,g,t,i,j,u,C,_,k,z;const f=T.useRef(null);T.useEffect(()=>{if(!r)return;const P=setTimeout(()=>{r&&f.current&&f.current.focus()},100);return()=>clearTimeout(P)},[r]);const{control:D,register:b,handleSubmit:n,getValues:c,formState:{errors:s},setError:L,reset:y}=Q({resolver:q(K)}),v={country:(a==null?void 0:a.country)||"",city:(a==null?void 0:a.city)||"",locality:(a==null?void 0:a.locality)||"",address:(a==null?void 0:a.address)||"",postalCode:(a==null?void 0:a.postal_code)||""},{isDirty:I}=xe({control:D}),m=()=>!I;T.useEffect(()=>{a&&y(v)},[a]);const{updateAddressClient:S}=O(),E=async P=>{if(!m())return new Promise((Y,A)=>{S.mutateAsync({clientId:a.client_id,addressId:a.id,...P}).then(()=>{d(),N("Morada atualizada com sucesso!"),Y()}).catch(Z=>{if(Z.error.code==="CLI-004")return["country","city","locality","address","postalCode"].forEach(w=>{L(w,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})}),A();d(),V("Erro ao atualizar morada!"),A()})})};return e.jsx(J,{mode:"form",title:"Editar Morada",open:r,onClose:d,submitButtonText:"Editar Morada",onSubmit:n(E),disabled:m(),children:e.jsx(F,{sx:{padding:3,paddingTop:1},children:e.jsxs(p,{container:!0,spacing:2,children:[e.jsx(p,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...b("country"),label:"País",error:!!s.country,helperText:(M=s.country)==null?void 0:M.message,autoComplete:"off",inputRef:f,InputLabelProps:{shrink:((g=c("country"))==null?void 0:g.length)>0}})})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...b("city"),label:"Cidade",error:!!s.city,helperText:(t=s.city)==null?void 0:t.message,autoComplete:"off",InputLabelProps:{shrink:((i=c("city"))==null?void 0:i.length)>0}})})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...b("locality"),label:"Localidade",error:!!s.locality,helperText:(j=s.locality)==null?void 0:j.message,autoComplete:"off",InputLabelProps:{shrink:((u=c("locality"))==null?void 0:u.length)>0}})})}),e.jsx(p,{item:!0,xs:12,children:e.jsxs(l,{sx:{flexDirection:"column",gap:2},children:[e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...b("address"),label:"Morada",error:!!s.address,helperText:(C=s.address)==null?void 0:C.message,autoComplete:"off",InputLabelProps:{shrink:((_=c("address"))==null?void 0:_.length)>0}})}),e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...b("postalCode"),label:"Código Postal",error:!!s.postalCode,helperText:(k=s.postalCode)==null?void 0:k.message,autoComplete:"off",InputLabelProps:{shrink:((z=c("postalCode"))==null?void 0:z.length)>0}})})]})})]})})})},be=({client:a,isLoading:r,isError:d})=>{var g;const f=!r&&!d,{role:D}=ee(),{deleteAddressClient:b}=O(),[n,c]=T.useState({isOpen:!1,clientAddress:null}),s=t=>{c({isOpen:!0,clientAddress:t})},L=()=>{c({isOpen:!1,clientAddress:null})},[y,v]=T.useState({isOpen:!1,clientAddress:null}),I=t=>{v({isOpen:!0,clientAddress:t})},m=()=>{v({isOpen:!1,clientAddress:null})},S=()=>new Promise((t,i)=>{y.clientAddress?b.mutateAsync({clientId:y.clientAddress.client_id,addressId:y.clientAddress.id}).then(()=>{m(),t()}).catch(()=>{m(),i()}):(m(),i())}),E=T.useMemo(()=>[{id:"country",label:"País",align:"left",sortable:!0},{id:"city",label:"Cidade",align:"left",sortable:!0},{id:"locality",label:"Localidade",align:"left",sortable:!0},{id:"address",label:"Morada",align:"left",sortable:!0},{id:"postal_code",label:"Código postal",align:"left",sortable:!0},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>{var i,j,u,C,_;return e.jsx(e.Fragment,{children:e.jsxs(l,{sx:{flexDirection:"row",gap:2},children:[e.jsx(l,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(B,{alt:(i=t==null?void 0:t.created_by_user)==null?void 0:i.username,src:`${R}/users/${(j=t==null?void 0:t.created_by_user)==null?void 0:j.id}/avatar?size=80`,name:(u=t==null?void 0:t.created_by_user)==null?void 0:u.username}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:(C=t==null?void 0:t.created_by_user)==null?void 0:C.username}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:(_=t==null?void 0:t.created_by_user)==null?void 0:_.role})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:U(t==null?void 0:t.created_at_datetime)}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:$(t==null?void 0:t.created_at_datetime)})]})]})})}},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>{var i,j,u,C,_;return e.jsx(e.Fragment,{children:t!=null&&t.last_modified_datetime?e.jsxs(l,{sx:{flexDirection:"row",gap:2},children:[e.jsx(l,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(B,{alt:(i=t==null?void 0:t.last_modified_by_user)==null?void 0:i.username,src:`${R}/users/${(j=t==null?void 0:t.last_modified_by_user)==null?void 0:j.id}/avatar?size=80`,name:(u=t==null?void 0:t.last_modified_by_user)==null?void 0:u.username}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:(C=t==null?void 0:t.last_modified_by_user)==null?void 0:C.username}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:(_=t==null?void 0:t.last_modified_by_user)==null?void 0:_.role})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:U(t==null?void 0:t.last_modified_datetime)}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:$(t==null?void 0:t.last_modified_datetime)})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})}},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(te,{mode:"custom",customButton:e.jsx(ae,{title:"Mais opções",sx:{margin:-1},children:e.jsx(se,{children:e.jsx(ie,{})})}),children:e.jsx(le,{buttons:[{label:"Editar",icon:e.jsx(he,{fontSize:"small"}),onClick:()=>s(t)},...D!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(re,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>I(t)}]:[]]})})}],[]),M=T.useMemo(()=>[{id:"client",label:"Cliente",formatter:()=>{var t;return(t=a==null?void 0:a[0])==null?void 0:t.name}},{id:"country",label:"País"},{id:"city",label:"Cidade"},{id:"locality",label:"Localidade"},{id:"address",label:"Morada"},{id:"postal_code",label:"Código postal"},{id:"created_by_user.username",label:"Criado por"},{id:"created_at_datetime",label:"Data de criação",formatter:t=>t?G(t):""},{id:"last_modified_by_user.username",label:"Modificado pela última vez por"},{id:"last_modified_datetime",label:"Última data de modificação",formatter:t=>t?G(t):""}],[a]);return e.jsxs(l,{children:[e.jsx(H,{title:"Moradas",description:"Moradas do cliente",icon:e.jsx(X,{})}),e.jsx(oe,{isLoading:!f,LoadingComponent:e.jsx(de,{mode:"datatable"}),LoadedComponent:e.jsx(F,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(ne,{mode:"datatable",data:f?(g=a[0])==null?void 0:g.addresses:[],columns:E,exportFileName:"moradas_cliente",exportColumns:M})})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(fe,{clientAddress:n.clientAddress,open:n.isOpen,onClose:L}),e.jsx(J,{mode:"delete",title:"Eliminar Morada",open:y.isOpen,onClose:m,onSubmit:S,description:"Tem a certeza que deseja eliminar esta morada?",subDescription:"Ao eliminar esta morada, os dados serão removidos de forma permanente."})]})},je=({client:a,isLoading:r,isError:d})=>{var m,S,E,M,g;const f=!r&&!d,D=ce(),b=me(D.breakpoints.down("sm")),{register:n,handleSubmit:c,formState:{errors:s},setError:L,reset:y}=Q({resolver:q(K)}),{addNewAddressClient:v}=O(),I=async t=>{f&&await v.mutateAsync({clientId:a[0].id,...t}).then(()=>{y(),N("Morada adicionada com sucesso!")}).catch(i=>{if(i.error.code==="CLI-004"){["country","city","locality","address","postalCode"].forEach(u=>{L(u,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})});return}V("Erro ao adicionar morada!")})};return e.jsxs(l,{children:[e.jsx(H,{title:"Morada",description:"Adicionar nova morada ao cliente",icon:e.jsx(X,{})}),e.jsx("form",{onSubmit:c(I),children:e.jsxs(l,{children:[e.jsxs(p,{container:!0,spacing:2,sx:{paddingInline:3},children:[e.jsx(p,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...n("country"),label:"País",error:!!s.country,helperText:(m=s.country)==null?void 0:m.message,autoComplete:"off"})})}),e.jsx(p,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...n("city"),label:"Cidade",error:!!s.city,helperText:(S=s.city)==null?void 0:S.message,autoComplete:"off"})})}),e.jsx(p,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...n("locality"),label:"Localidade",error:!!s.locality,helperText:(E=s.locality)==null?void 0:E.message,autoComplete:"off"})})}),e.jsx(p,{item:!0,xs:12,md:12,lg:6,children:e.jsxs(l,{sx:{flexDirection:b?"column":"row",gap:2},children:[e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...n("address"),label:"Morada",error:!!s.address,helperText:(M=s.address)==null?void 0:M.message,autoComplete:"off"})}),e.jsx(x,{fullWidth:!0,children:e.jsx(h,{...n("postalCode"),label:"Código Postal",error:!!s.postalCode,helperText:(g=s.postalCode)==null?void 0:g.message,autoComplete:"off"})})]})})]}),e.jsx(F,{sx:{marginLeft:"auto",padding:3},children:e.jsx(ue,{loading:v.isPending,type:"submit",variant:"contained",disabled:!f,children:"Adicionar Morada"})})]})})]})},Ee=({client:a,isLoading:r,isError:d})=>e.jsxs(pe,{elevation:1,children:[e.jsx(be,{client:a,isLoading:r,isError:d}),e.jsx(je,{client:a,isLoading:r,isError:d})]});export{Ee as default};
