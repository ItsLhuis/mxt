import{e as O,r as g,j as t,S as n,be as $,bf as P,bg as W,h as s,aZ as k,a_ as S,a$ as F,aE as H,aF as N,aH as E,aj as D,ax as R,ay as U,b0 as K,H as z,aM as Z,b1 as G,B as M,aC as J,bh as Q,b2 as X,bI as Y,L as w,f as ee}from"./index-C9HasOiM.js";import{u as T}from"./useEquipment-ClzBGdbo.js";import{V as te}from"./Visibility-B00d3i-B.js";import{M as ne}from"./MoreVert-CDz2P5kD.js";import{A as V}from"./Attachment-ukPOh3N_.js";import{u as ae,t as ie,C as se}from"./index-BTi6rd4V.js";import{a as le}from"./equipment-D4V42Xnu.js";import"./equipment-DQ8Bx2dX.js";const me=({equipment:l,isLoading:m,isError:o})=>{var q;const r=!m&&!o,{role:_}=O(),{deleteEquipmentAttachment:v}=T(),[c,p]=g.useState(!1),[a,u]=g.useState({url:"",name:"",size:"",type:""}),d=(e,i,j,b)=>{u({url:e,name:i,size:j,type:b}),p(!0)},x=()=>{p(!1),u({url:"",type:""})},[h,A]=g.useState({isOpen:!1,equipmentAttachment:null}),B=e=>{A({isOpen:!0,equipmentAttachment:e})},f=()=>{A({isOpen:!1,equipmentAttachment:null})},I=()=>new Promise((e,i)=>{h.equipmentAttachment?v.mutateAsync({equipmentId:h.equipmentAttachment.equipment_id,attachmentId:h.equipmentAttachment.id}).then(()=>{f(),e()}).catch(()=>{f(),i()}):(f(),i())}),L=g.useMemo(()=>[{id:"file_mime_type",label:"Tipo",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsx(n,{sx:{alignItems:"flex-start"},children:(e==null?void 0:e.file_mime_type)==="application/pdf"?t.jsx("img",{src:$}):e!=null&&e.file_mime_type.startsWith("image/")?t.jsx("img",{src:P}):t.jsx("img",{src:W})})},{id:"original_filename",label:"Ficheiro",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsxs(n,{children:[t.jsx(s,{variant:"p",component:"p",children:e==null?void 0:e.original_filename}),t.jsx(s,{variant:"p",component:"p",sx:{color:"var(--outline)"},children:`${(e==null?void 0:e.file_size)<1024*1024?((e==null?void 0:e.file_size)/1024).toFixed(2)+" Kb":((e==null?void 0:e.file_size)/(1024*1024)).toFixed(2)+" Mb"}`})]})},{id:"uploaded_by_user",visible:!1},{id:"uploaded_at_datetime",label:"Carregado por",align:"left",sortable:!0,renderComponent:({row:e})=>{var i,j,b,y,C;return t.jsx(t.Fragment,{children:t.jsxs(n,{sx:{flexDirection:"row",gap:2},children:[t.jsx(n,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:e!=null&&e.uploaded_by_user?t.jsxs(t.Fragment,{children:[t.jsx(k,{alt:(i=e==null?void 0:e.uploaded_by_user)==null?void 0:i.username,src:`${S}/users/${(j=e==null?void 0:e.uploaded_by_user)==null?void 0:j.id}/avatar?size=80`,name:(b=e==null?void 0:e.uploaded_by_user)==null?void 0:b.username}),t.jsxs(n,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:(y=e==null?void 0:e.uploaded_by_user)==null?void 0:y.username}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:(C=e==null?void 0:e.uploaded_by_user)==null?void 0:C.role})]})]}):t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),t.jsx(F,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsxs(n,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:H(e==null?void 0:e.uploaded_at_datetime)}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:N(e==null?void 0:e.uploaded_at_datetime)})]})]})})}},{id:"view_file",align:"right",sortable:!1,renderComponent:({row:e})=>t.jsx(E,{title:"Ver anexo",sx:{margin:-1},children:t.jsx(D,{onClick:()=>d(`${S}/equipments/${e==null?void 0:e.equipment_id}/attachments/${e==null?void 0:e.id}/${e==null?void 0:e.original_filename}`,e==null?void 0:e.original_filename,e==null?void 0:e.file_size,e==null?void 0:e.file_mime_type),children:t.jsx(te,{})})})},{id:"more_options",align:"right",sortable:!1,disablePadding:!0,renderComponent:({row:e})=>{if(_!=="Funcionário")return t.jsx(R,{mode:"custom",customButton:t.jsx(E,{title:"Mais opções",sx:{margin:-1},children:t.jsx(D,{children:t.jsx(ne,{})})}),children:t.jsx(U,{buttons:[{label:"Eliminar",icon:t.jsx(K,{fontSize:"small",color:"error"}),color:"error",onClick:()=>B(e)}]})})}}],[]);return t.jsxs(n,{children:[t.jsx(z,{title:"Anexos",description:"Anexos do equipamento",icon:t.jsx(V,{})}),t.jsx(Z,{isLoading:!r,LoadingComponent:t.jsx(G,{mode:"datatable"}),LoadedComponent:t.jsx(M,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:t.jsx(J,{mode:"datatable",data:r?(q=l[0])==null?void 0:q.attachments:[],columns:L})})}),t.jsx(F,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsx(Q,{open:c,onClose:x,file:a.url,fileName:a.name,fileSize:Number(a.size),fileType:a.type}),t.jsx(X,{mode:"delete",title:"Eliminar Anexo",open:h.isOpen,onClose:f,onSubmit:I,description:"Tem a certeza que deseja eliminar este anexo?",subDescription:"Ao eliminar este anexo, os dados serão removidos de forma permanente."})]})},oe=({equipment:l,isLoading:m,isError:o})=>{const r=!m&&!o,{control:_,handleSubmit:v,formState:{errors:c},reset:p}=ae({resolver:ie(le),defaultValues:{attachments:[]}}),{addNewEquipmentAttachment:a}=T(),u=async d=>{r&&await a.mutateAsync({equipmentId:l[0].id,...d}).then(()=>p())};return t.jsxs(n,{children:[t.jsx(z,{title:"Anexos",description:"Adicionar novos anexos ao equipamento",icon:t.jsx(V,{})}),t.jsx("form",{onSubmit:v(u),children:t.jsxs(n,{sx:{padding:3,gap:3},children:[t.jsx(se,{name:"attachments",control:_,defaultValue:"",render:({field:d})=>{var x;return t.jsx(Y,{disabled:a.isPending,value:d.value,onChange:d.onChange,error:!!c.attachments,helperText:(x=c.attachments)==null?void 0:x.message})}}),t.jsx(M,{sx:{marginLeft:"auto"},children:t.jsx(w,{loading:a.isPending,type:"submit",variant:"contained",disabled:!r,children:"Adicionar Anexos"})})]})})]})},je=({equipment:l,isLoading:m,isError:o})=>t.jsxs(ee,{elevation:1,children:[t.jsx(me,{equipment:l,isLoading:m,isError:o}),t.jsx(oe,{equipment:l,isLoading:m,isError:o})]});export{je as default};
