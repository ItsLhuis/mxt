import{r as T,j as e,aT as $,B as L,G as M,F as _,aV as N,T as I,b2 as U,aj as H,s as J,e as ee,S as d,a$ as te,h as p,aE as A,aF as P,aH as O,aI as R,aJ as B,aK as ae,aL as ne,ag as oe,aM as se,aN as ie,aO as le,aP as V,H as G,aQ as re,aR as ce,aS as de,L as me,f as ue}from"./index-D-gKbxy2.js";import{u as z}from"./useClient-BBU6ub_Q.js";import{u as q,t as K,b as pe,a as Q,C as D}from"./index-DampQ2Jc.js";import{a as X}from"./client-Dureap31.js";import{C as Y}from"./mui-tel-input.es-BQ0Mi011.js";import{f as k}from"./phone-B8ybmA3k.js";import{E as xe}from"./Edit-CF1aRa9K.js";import{P as Z}from"./Phone-JMV_D93I.js";import"./client-C5_WL1II.js";import"./isPossiblePhoneNumber-DES16dOz.js";const he=({clientContact:a,open:m,onClose:x})=>{var W,t,u,g;const j=T.useRef(null);T.useEffect(()=>{if(!m)return;const n=setTimeout(()=>{m&&j.current&&j.current.focus()},100);return()=>clearTimeout(n)},[m]);const{control:r,register:y,handleSubmit:E,getValues:s,formState:{errors:c},setError:F,reset:C}=q({resolver:K(X)}),b={type:(a==null?void 0:a.type)||"",contact:(a==null?void 0:a.contact)||"",description:(a==null?void 0:a.description)||""},{isDirty:v}=pe({control:r}),h=()=>!v;T.useEffect(()=>{a&&C(b)},[a]);const{updateContactClient:S}=z(),o=async n=>{if(!h())return new Promise((l,f)=>{S.mutateAsync({clientId:a.client_id,contactId:a.id,...n,description:n.description===""?null:n.description}).then(()=>{x(),H("Contacto atualizado com sucesso!"),l()}).catch(w=>{if(w.error.code==="CLI-004")return F("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"}),f();x(),J("Erro ao atualizar contacto!"),f()})})},i=Q({control:r,name:"type"});return e.jsx($,{mode:"form",title:"Editar Contacto",open:m,onClose:x,submitButtonText:"Editar Contacto",onSubmit:E(o),disabled:h(),children:e.jsx(L,{sx:{padding:3,paddingTop:1},children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,children:e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"type",control:r,render:({field:n})=>{var l;return e.jsx(N,{ref:n.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:n.value,onChange:n.onChange,error:!!c.type,helperText:(l=c.type)==null?void 0:l.message,inputRef:j})}})})}),e.jsx(M,{item:!0,xs:12,children:i==="E-mail"?e.jsx(_,{fullWidth:!0,children:e.jsx(I,{...y("contact"),label:"E-mail",error:!!c.contact,helperText:(W=c.contact)==null?void 0:W.message,autoComplete:"off",InputLabelProps:{shrink:((t=s("contact"))==null?void 0:t.length)>0}})}):e.jsx(e.Fragment,{children:i==="Telefone"||i==="Telemóvel"?e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"contact",control:r,render:({field:n})=>{var l;return e.jsx(Y,{...n,value:b.type==="Telefone"||b.type==="Telemóvel"?n.value:"+351",onChange:f=>{n.onChange(f.replace(/\s+/g,""))},defaultCountry:"pt",label:i,variant:"outlined",fullWidth:!0,error:!!c.contact,helperText:(l=c.contact)==null?void 0:l.message,autoComplete:"off",disableDropdown:!0})}})}):e.jsx(_,{fullWidth:!0,children:e.jsx(I,{...y("contact"),label:"Contacto",error:!!c.contact,helperText:(u=c.contact)==null?void 0:u.message,autoComplete:"off",InputLabelProps:{shrink:((g=s("contact"))==null?void 0:g.length)>0}})})})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(D,{name:"description",control:r,render:({field:n})=>e.jsx(U,{label:"Descrição",value:n.value,onChange:n.onChange,shouldImmediatelyRender:!0})})})]})})})},fe=({client:a,isLoading:m,isError:x})=>{var W;const j=!m&&!x,{role:r}=ee(),{deleteContactClient:y}=z(),[E,s]=T.useState({isOpen:!1,clientContact:null}),c=t=>{s({isOpen:!0,clientContact:t})},F=()=>{s({isOpen:!1,clientContact:null})},[C,b]=T.useState({isOpen:!1,clientContact:null}),v=t=>{b({isOpen:!0,clientContact:t})},h=()=>{b({isOpen:!1,clientContact:null})},S=()=>new Promise((t,u)=>{C.clientContact?y.mutateAsync({clientId:C.clientContact.client_id,contactId:C.clientContact.id}).then(()=>{h(),t()}).catch(()=>{h(),u()}):(h(),u())}),o=T.useMemo(()=>[{id:"type",label:"Tipo",align:"left",sortable:!0},{id:"contact",label:"Contacto",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsxs(d,{sx:{flexDirection:"row",alignItems:"center",gap:1},children:[e.jsx(e.Fragment,{children:k(t==null?void 0:t.contact)}),(t==null?void 0:t.description)&&e.jsx(te,{fontSize:"small",title:t==null?void 0:t.description})]})},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>{var u,g,n,l,f;return e.jsx(e.Fragment,{children:e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(A,{alt:(u=t==null?void 0:t.created_by_user)==null?void 0:u.username,src:`${P}/users/${(g=t==null?void 0:t.created_by_user)==null?void 0:g.id}/avatar?size=80`,name:(n=t==null?void 0:t.created_by_user)==null?void 0:n.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:(l=t==null?void 0:t.created_by_user)==null?void 0:l.username}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:(f=t==null?void 0:t.created_by_user)==null?void 0:f.role})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(O,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:R(t==null?void 0:t.created_at_datetime)}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:B(t==null?void 0:t.created_at_datetime)})]})]})})}},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>{var u,g,n,l,f;return e.jsx(e.Fragment,{children:t!=null&&t.last_modified_datetime?e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(A,{alt:(u=t==null?void 0:t.last_modified_by_user)==null?void 0:u.username,src:`${P}/users/${(g=t==null?void 0:t.last_modified_by_user)==null?void 0:g.id}/avatar?size=80`,name:(n=t==null?void 0:t.last_modified_by_user)==null?void 0:n.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:(l=t==null?void 0:t.last_modified_by_user)==null?void 0:l.username}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:(f=t==null?void 0:t.last_modified_by_user)==null?void 0:f.role})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(O,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:R(t==null?void 0:t.last_modified_datetime)}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:B(t==null?void 0:t.last_modified_datetime)})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})}},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(ae,{mode:"custom",customButton:e.jsx(ne,{title:"Mais opções",sx:{margin:-1},children:e.jsx(oe,{children:e.jsx(se,{})})}),children:e.jsx(ie,{buttons:[{label:"Editar",icon:e.jsx(xe,{fontSize:"small"}),onClick:()=>c(t)},...r!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(le,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>v(t)}]:[]]})})}],[]),i=T.useMemo(()=>[{id:"client",label:"Cliente",formatter:()=>{var t;return(t=a==null?void 0:a[0])==null?void 0:t.name}},{id:"type",label:"Tipo"},{id:"contact",label:"Contacto",formatter:k},{id:"created_by_user.username",label:"Criado por"},{id:"created_at_datetime",label:"Data de criação",formatter:t=>t?V(t):""},{id:"last_modified_by_user.username",label:"Modificado pela última vez por"},{id:"last_modified_datetime",label:"Última data de modificação",formatter:t=>t?V(t):""}],[a]);return e.jsxs(d,{children:[e.jsx(G,{title:"Contactos",description:"Contactos do cliente",icon:e.jsx(Z,{})}),e.jsx(re,{isLoading:!j,LoadingComponent:e.jsx(ce,{mode:"datatable"}),LoadedComponent:e.jsx(L,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(de,{mode:"datatable",data:j?(W=a[0])==null?void 0:W.contacts:[],columns:o,exportFileName:"contactos_cliente",exportColumns:i})})}),e.jsx(O,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(he,{clientContact:E.clientContact,open:E.isOpen,onClose:F}),e.jsx($,{mode:"delete",title:"Eliminar Contacto",open:C.isOpen,onClose:h,onSubmit:S,description:"Tem a certeza que deseja eliminar este contacto?",subDescription:"Ao eliminar este contacto, os dados serão removidos de forma permanente."})]})},je=({client:a,isLoading:m,isError:x})=>{var h,S;const j=!m&&!x,{control:r,register:y,handleSubmit:E,formState:{errors:s},setError:c,reset:F}=q({resolver:K(X)}),{addNewContactClient:C}=z(),b=async o=>{j&&await C.mutateAsync({clientId:a[0].id,...o,description:o.description===""?null:o.description}).then(()=>{F(),H("Contacto adicionado com sucesso!")}).catch(i=>{if(i.error.code==="CLI-002"){c("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"});return}J("Erro ao adicionar contacto!")})},v=Q({control:r,name:"type"});return e.jsxs(d,{children:[e.jsx(G,{title:"Contacto",description:"Adicionar novo contacto ao cliente",icon:e.jsx(Z,{})}),e.jsx("form",{onSubmit:E(b),children:e.jsxs(d,{sx:{padding:3,gap:2},children:[e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"type",control:r,defaultValue:"",render:({field:o})=>{var i;return e.jsx(N,{ref:o.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:o.value,onChange:o.onChange,error:!!s.type,helperText:(i=s.type)==null?void 0:i.message})}})}),v==="E-mail"?e.jsx(_,{fullWidth:!0,children:e.jsx(I,{...y("contact"),label:"E-mail",error:!!s.contact,helperText:(h=s.contact)==null?void 0:h.message,autoComplete:"off"})}):e.jsx(e.Fragment,{children:v==="Telefone"||v==="Telemóvel"?e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"contact",control:r,defaultValue:"+351",render:({field:o})=>{var i;return e.jsx(Y,{...o,value:o.value||"+351",defaultCountry:"pt",label:v,variant:"outlined",fullWidth:!0,error:!!s.contact,helperText:(i=s.contact)==null?void 0:i.message,autoComplete:"off",disableDropdown:!0})}})}):e.jsx(_,{fullWidth:!0,children:e.jsx(I,{...y("contact"),label:"Contacto",error:!!s.contact,helperText:(S=s.contact)==null?void 0:S.message,autoComplete:"off"})})}),e.jsx(D,{name:"description",control:r,defaultValue:"",render:({field:o})=>e.jsx(U,{label:"Descrição",value:o.value,onChange:o.onChange,shouldImmediatelyRender:!0})}),e.jsx(L,{sx:{marginLeft:"auto",marginTop:1},children:e.jsx(me,{loading:C.isPending,type:"submit",variant:"contained",disabled:!j,children:"Adicionar Contacto"})})]})})]})},Fe=({client:a,isLoading:m,isError:x})=>e.jsxs(ue,{elevation:1,children:[e.jsx(fe,{client:a,isLoading:m,isError:x}),e.jsx(je,{client:a,isLoading:m,isError:x})]});export{Fe as default};
