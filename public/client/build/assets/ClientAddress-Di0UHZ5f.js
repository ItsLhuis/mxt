import{r as T,j as e,b2 as H,B as P,G as x,F as h,T as f,S as l,ab as V,s as G,e as w,h as o,aZ as B,a_ as R,a$ as W,aE as $,aF as U,ax as ee,aH as te,aj as se,ay as ae,b0 as ie,H as J,aM as le,b1 as re,aC as oe,b as ne,a as de,L as ce,f as ue}from"./index-C9HasOiM.js";import{u as F}from"./useClient-C9FOb7yq.js";import{u as q,t as N,b as me}from"./index-BTi6rd4V.js";import{b as Q}from"./client-Dy9TJCig.js";import{M as pe}from"./MoreVert-CDz2P5kD.js";import{E as xe}from"./Edit-CYRFZ1bJ.js";import{P as Z}from"./Place-CPuVfo0F.js";import"./client-CVPJ2IqU.js";import"./isPossiblePhoneNumber-C2Df4Gz7.js";const he=({clientAddress:s,open:r,onClose:n})=>{var C,t,i,m,g,p,v,O,k,z;const j=T.useRef(null);T.useEffect(()=>{if(!r)return;const I=setTimeout(()=>{r&&j.current&&j.current.focus()},100);return()=>clearTimeout(I)},[r]);const{control:E,register:b,handleSubmit:d,getValues:c,formState:{errors:a},setError:D,reset:y}=q({resolver:N(Q)}),_={country:(s==null?void 0:s.country)||"",city:(s==null?void 0:s.city)||"",locality:(s==null?void 0:s.locality)||"",address:(s==null?void 0:s.address)||"",postalCode:(s==null?void 0:s.postal_code)||""},{isDirty:L}=me({control:E}),u=()=>!L;T.useEffect(()=>{s&&y(_)},[s]);const{updateAddressClient:M}=F(),S=async I=>{if(!u())return new Promise((K,A)=>{M.mutateAsync({clientId:s.client_id,addressId:s.id,...I}).then(()=>{n(),V("Morada atualizada com sucesso!"),K()}).catch(X=>{if(X.error.code==="CLI-004")return["country","city","locality","address","postalCode"].forEach(Y=>{D(Y,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})}),A();n(),G("Erro ao atualizar morada!"),A()})})};return e.jsx(H,{mode:"form",title:"Editar Morada",open:r,onClose:n,submitButtonText:"Editar Morada",onSubmit:d(S),disabled:u(),children:e.jsx(P,{sx:{padding:3,paddingTop:1},children:e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...b("country"),label:"País",error:!!a.country,helperText:(C=a.country)==null?void 0:C.message,autoComplete:"off",inputRef:j,InputLabelProps:{shrink:((t=c("country"))==null?void 0:t.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...b("city"),label:"Cidade",error:!!a.city,helperText:(i=a.city)==null?void 0:i.message,autoComplete:"off",InputLabelProps:{shrink:((m=c("city"))==null?void 0:m.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...b("locality"),label:"Localidade",error:!!a.locality,helperText:(g=a.locality)==null?void 0:g.message,autoComplete:"off",InputLabelProps:{shrink:((p=c("locality"))==null?void 0:p.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(l,{sx:{flexDirection:"column",gap:2},children:[e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...b("address"),label:"Morada",error:!!a.address,helperText:(v=a.address)==null?void 0:v.message,autoComplete:"off",InputLabelProps:{shrink:((O=c("address"))==null?void 0:O.length)>0}})}),e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...b("postalCode"),label:"Código Postal",error:!!a.postalCode,helperText:(k=a.postalCode)==null?void 0:k.message,autoComplete:"off",InputLabelProps:{shrink:((z=c("postalCode"))==null?void 0:z.length)>0}})})]})})]})})})},fe=({client:s,isLoading:r,isError:n})=>{var C;const j=!r&&!n,{role:E}=w(),{deleteAddressClient:b}=F(),[d,c]=T.useState({isOpen:!1,clientAddress:null}),a=t=>{c({isOpen:!0,clientAddress:t})},D=()=>{c({isOpen:!1,clientAddress:null})},[y,_]=T.useState({isOpen:!1,clientAddress:null}),L=t=>{_({isOpen:!0,clientAddress:t})},u=()=>{_({isOpen:!1,clientAddress:null})},M=()=>new Promise((t,i)=>{y.clientAddress?b.mutateAsync({clientId:y.clientAddress.client_id,addressId:y.clientAddress.id}).then(()=>{u(),t()}).catch(()=>{u(),i()}):(u(),i())}),S=T.useMemo(()=>[{id:"country",label:"País",align:"left",sortable:!0},{id:"city",label:"Cidade",align:"left",sortable:!0},{id:"locality",label:"Localidade",align:"left",sortable:!0},{id:"address",label:"Morada",align:"left",sortable:!0},{id:"postal_code",label:"Código postal",align:"left",sortable:!0},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>{var i,m,g,p,v;return e.jsx(e.Fragment,{children:e.jsxs(l,{sx:{flexDirection:"row",gap:2},children:[e.jsx(l,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(B,{alt:(i=t==null?void 0:t.created_by_user)==null?void 0:i.username,src:`${R}/users/${(m=t==null?void 0:t.created_by_user)==null?void 0:m.id}/avatar?size=80`,name:(g=t==null?void 0:t.created_by_user)==null?void 0:g.username}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:(p=t==null?void 0:t.created_by_user)==null?void 0:p.username}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:(v=t==null?void 0:t.created_by_user)==null?void 0:v.role})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:$(t==null?void 0:t.created_at_datetime)}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:U(t==null?void 0:t.created_at_datetime)})]})]})})}},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>{var i,m,g,p,v;return e.jsx(e.Fragment,{children:t!=null&&t.last_modified_datetime?e.jsxs(l,{sx:{flexDirection:"row",gap:2},children:[e.jsx(l,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(B,{alt:(i=t==null?void 0:t.last_modified_by_user)==null?void 0:i.username,src:`${R}/users/${(m=t==null?void 0:t.last_modified_by_user)==null?void 0:m.id}/avatar?size=80`,name:(g=t==null?void 0:t.last_modified_by_user)==null?void 0:g.username}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:(p=t==null?void 0:t.last_modified_by_user)==null?void 0:p.username}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:(v=t==null?void 0:t.last_modified_by_user)==null?void 0:v.role})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(l,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(o,{variant:"p",component:"p",fontWeight:500,children:$(t==null?void 0:t.last_modified_datetime)}),e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:U(t==null?void 0:t.last_modified_datetime)})]})]}):e.jsx(o,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})}},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(ee,{mode:"custom",customButton:e.jsx(te,{title:"Mais opções",sx:{margin:-1},children:e.jsx(se,{children:e.jsx(pe,{})})}),children:e.jsx(ae,{buttons:[{label:"Editar",icon:e.jsx(xe,{fontSize:"small"}),onClick:()=>a(t)},...E!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(ie,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>L(t)}]:[]]})})}],[]);return e.jsxs(l,{children:[e.jsx(J,{title:"Moradas",description:"Moradas do cliente",icon:e.jsx(Z,{})}),e.jsx(le,{isLoading:!j,LoadingComponent:e.jsx(re,{mode:"datatable"}),LoadedComponent:e.jsx(P,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(oe,{mode:"datatable",data:j?(C=s[0])==null?void 0:C.addresses:[],columns:S})})}),e.jsx(W,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(he,{clientAddress:d.clientAddress,open:d.isOpen,onClose:D}),e.jsx(H,{mode:"delete",title:"Eliminar Morada",open:y.isOpen,onClose:u,onSubmit:M,description:"Tem a certeza que deseja eliminar esta morada?",subDescription:"Ao eliminar esta morada, os dados serão removidos de forma permanente."})]})},je=({client:s,isLoading:r,isError:n})=>{var u,M,S,C,t;const j=!r&&!n,E=ne(),b=de(E.breakpoints.down("sm")),{register:d,handleSubmit:c,formState:{errors:a},setError:D,reset:y}=q({resolver:N(Q)}),{addNewAddressClient:_}=F(),L=async i=>{j&&await _.mutateAsync({clientId:s[0].id,...i}).then(()=>{y(),V("Morada adicionada com sucesso!")}).catch(m=>{if(m.error.code==="CLI-004"){["country","city","locality","address","postalCode"].forEach(p=>{D(p,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})});return}G("Erro ao adicionar morada!")})};return e.jsxs(l,{children:[e.jsx(J,{title:"Morada",description:"Adicionar nova morada ao cliente",icon:e.jsx(Z,{})}),e.jsx("form",{onSubmit:c(L),children:e.jsxs(l,{children:[e.jsxs(x,{container:!0,spacing:2,sx:{paddingInline:3},children:[e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...d("country"),label:"País",error:!!a.country,helperText:(u=a.country)==null?void 0:u.message,autoComplete:"off"})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...d("city"),label:"Cidade",error:!!a.city,helperText:(M=a.city)==null?void 0:M.message,autoComplete:"off"})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...d("locality"),label:"Localidade",error:!!a.locality,helperText:(S=a.locality)==null?void 0:S.message,autoComplete:"off"})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsxs(l,{sx:{flexDirection:b?"column":"row",gap:2},children:[e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...d("address"),label:"Morada",error:!!a.address,helperText:(C=a.address)==null?void 0:C.message,autoComplete:"off"})}),e.jsx(h,{fullWidth:!0,children:e.jsx(f,{...d("postalCode"),label:"Código Postal",error:!!a.postalCode,helperText:(t=a.postalCode)==null?void 0:t.message,autoComplete:"off"})})]})})]}),e.jsx(P,{sx:{marginLeft:"auto",padding:3},children:e.jsx(ce,{loading:_.isPending,type:"submit",variant:"contained",disabled:!j,children:"Adicionar Morada"})})]})})]})},De=({client:s,isLoading:r,isError:n})=>e.jsxs(ue,{elevation:1,children:[e.jsx(fe,{client:s,isLoading:r,isError:n}),e.jsx(je,{client:s,isLoading:r,isError:n})]});export{De as default};
