import{e as $,r as g,j as t,S as a,bc as P,bd as W,be as E,h as s,aV as k,aW as F,aE as R,aM as N,aN as U,aP as D,ag as V,aF as q,aQ as H,aG as K,aX as G,H as z,aZ as Q,a_ as X,B as T,aK as Z,bf as J,a$ as Y,bI as w,L as ee,f as te}from"./index-DJpfvod0.js";import{u as M}from"./useRepair-DQBibyZW.js";import{V as ae}from"./Visibility-e42ycFBn.js";import{A as B}from"./Attachment-DsyIoV6K.js";import{u as ie,t as ne,C as se}from"./index-o_NukjCy.js";import{b as le}from"./repair-LpirZ2QJ.js";import"./repair-CTbFyE7G.js";const re=({repair:l,isLoading:r,isError:o})=>{var y;const m=!r&&!o,{role:_}=$(),{deleteRepairAttachment:v}=M(),[c,p]=g.useState(!1),[i,x]=g.useState({url:"",name:"",size:"",type:""}),d=(e,n,j,b)=>{x({url:e,name:n,size:j,type:b}),p(!0)},u=()=>{p(!1),x({url:"",type:""})},[h,A]=g.useState({isOpen:!1,repairAttachment:null}),I=e=>{A({isOpen:!0,repairAttachment:e})},f=()=>{A({isOpen:!1,repairAttachment:null})},L=()=>new Promise((e,n)=>{h.repairAttachment?v.mutateAsync({repairId:h.repairAttachment.repair_id,attachmentId:h.repairAttachment.id}).then(()=>{f(),e()}).catch(()=>{f(),n()}):(f(),n())}),O=g.useMemo(()=>[{id:"file_mime_type",label:"Tipo",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsx(a,{sx:{alignItems:"flex-start"},children:(e==null?void 0:e.file_mime_type)==="application/pdf"?t.jsx("img",{src:P}):e!=null&&e.file_mime_type.startsWith("image/")?t.jsx("img",{src:W}):t.jsx("img",{src:E})})},{id:"original_filename",label:"Ficheiro",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsxs(a,{children:[t.jsx(s,{variant:"p",component:"p",children:e==null?void 0:e.original_filename}),t.jsx(s,{variant:"p",component:"p",sx:{color:"var(--outline)"},children:`${(e==null?void 0:e.file_size)<1024*1024?((e==null?void 0:e.file_size)/1024).toFixed(2)+" Kb":((e==null?void 0:e.file_size)/(1024*1024)).toFixed(2)+" Mb"}`})]})},{id:"uploaded_by_user",visible:!1},{id:"uploaded_at_datetime",label:"Carregado por",align:"left",sortable:!0,renderComponent:({row:e})=>{var n,j,b,S,C;return t.jsx(t.Fragment,{children:t.jsxs(a,{sx:{flexDirection:"row",gap:2},children:[t.jsx(a,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:e!=null&&e.uploaded_by_user?t.jsxs(t.Fragment,{children:[t.jsx(k,{alt:(n=e==null?void 0:e.uploaded_by_user)==null?void 0:n.username,src:`${F}/users/${(j=e==null?void 0:e.uploaded_by_user)==null?void 0:j.id}/avatar?size=80`,name:(b=e==null?void 0:e.uploaded_by_user)==null?void 0:b.username}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:(S=e==null?void 0:e.uploaded_by_user)==null?void 0:S.username}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:(C=e==null?void 0:e.uploaded_by_user)==null?void 0:C.role})]})]}):t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:N(e==null?void 0:e.uploaded_at_datetime)}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:U(e==null?void 0:e.uploaded_at_datetime)})]})]})})}},{id:"view_file",align:"right",sortable:!1,renderComponent:({row:e})=>t.jsx(D,{title:"Ver anexo",sx:{margin:-1},children:t.jsx(V,{onClick:()=>d(`${F}/repairs/${e==null?void 0:e.repair_id}/attachments/${e==null?void 0:e.id}/${e==null?void 0:e.original_filename}`,e==null?void 0:e.original_filename,e==null?void 0:e.file_size,e==null?void 0:e.file_mime_type),children:t.jsx(ae,{})})})},{id:"more_options",align:"right",sortable:!1,disablePadding:!0,renderComponent:({row:e})=>{if(_!=="Funcionário")return t.jsx(q,{mode:"custom",customButton:t.jsx(D,{title:"Mais opções",sx:{margin:-1},children:t.jsx(V,{children:t.jsx(H,{})})}),children:t.jsx(K,{buttons:[{label:"Eliminar",icon:t.jsx(G,{fontSize:"small",color:"error"}),color:"error",onClick:()=>I(e)}]})})}}],[]);return t.jsxs(a,{children:[t.jsx(z,{title:"Anexos",description:"Anexos do equipamento",icon:t.jsx(B,{})}),t.jsx(Q,{isLoading:!m,LoadingComponent:t.jsx(X,{mode:"datatable"}),LoadedComponent:t.jsx(T,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:t.jsx(Z,{mode:"datatable",data:m?(y=l[0])==null?void 0:y.attachments:[],columns:O})})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsx(J,{open:c,onClose:u,file:i.url,fileName:i.name,fileSize:Number(i.size),fileType:i.type}),t.jsx(Y,{mode:"delete",title:"Eliminar Anexo",open:h.isOpen,onClose:f,onSubmit:L,description:"Tem a certeza que deseja eliminar este anexo?",subDescription:"Ao eliminar este anexo, os dados serão removidos de forma permanente."})]})},oe=({repair:l,isLoading:r,isError:o})=>{const m=!r&&!o,{control:_,handleSubmit:v,formState:{errors:c},reset:p}=ie({resolver:ne(le),defaultValues:{attachments:[]}}),{addNewRepairAttachment:i}=M(),x=async d=>{m&&await i.mutateAsync({repairId:l[0].id,...d}).then(()=>p())};return t.jsxs(a,{children:[t.jsx(z,{title:"Anexos",description:"Adicionar novos anexos à reparação",icon:t.jsx(B,{})}),t.jsx("form",{onSubmit:v(x),children:t.jsxs(a,{sx:{padding:3,gap:3},children:[t.jsx(se,{name:"attachments",control:_,defaultValue:"",render:({field:d})=>{var u;return t.jsx(w,{disabled:i.isPending,value:d.value,onChange:d.onChange,error:!!c.attachments,helperText:(u=c.attachments)==null?void 0:u.message})}}),t.jsx(T,{sx:{marginLeft:"auto"},children:t.jsx(ee,{loading:i.isPending,type:"submit",variant:"contained",disabled:!m,children:"Adicionar Anexos"})})]})})]})},fe=({repair:l,isLoading:r,isError:o})=>t.jsxs(te,{elevation:1,children:[t.jsx(re,{repair:l,isLoading:r,isError:o}),t.jsx(oe,{repair:l,isLoading:r,isError:o})]});export{fe as default};
