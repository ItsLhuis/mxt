import{r as S,j as e,b2 as k,B as L,G as M,F as _,b4 as V,T as O,bc as $,ab as U,s as H,e as Y,S as d,aN as w,h as p,aZ as A,a_ as B,a$ as I,aE as P,aF as R,ax as ee,aH as te,aj as ae,ay as ne,b0 as se,H as N,aM as oe,b1 as ie,aC as le,L as re,f as ce}from"./index-C9HasOiM.js";import{u as z}from"./useClient-C9FOb7yq.js";import{u as G,t as J,b as de,a as q,C as D}from"./index-BTi6rd4V.js";import{a as Z}from"./client-Dy9TJCig.js";import{C as K}from"./mui-tel-input.es-Dwf2nM_M.js";import{f as me}from"./phone-CfgKBj3V.js";import{M as ue}from"./MoreVert-CDz2P5kD.js";import{E as pe}from"./Edit-CYRFZ1bJ.js";import{P as Q}from"./Phone-DvakulYD.js";import"./client-CVPJ2IqU.js";import"./isPossiblePhoneNumber-C2Df4Gz7.js";const xe=({clientContact:n,open:m,onClose:x})=>{var t,u,v,g;const f=S.useRef(null);S.useEffect(()=>{if(!m)return;const a=setTimeout(()=>{m&&f.current&&f.current.focus()},100);return()=>clearTimeout(a)},[m]);const{control:r,register:y,handleSubmit:T,getValues:i,formState:{errors:c},setError:F,reset:j}=G({resolver:J(Z)}),C={type:(n==null?void 0:n.type)||"",contact:(n==null?void 0:n.contact)||"",description:(n==null?void 0:n.description)||""},{isDirty:b}=de({control:r}),h=()=>!b;S.useEffect(()=>{n&&j(C)},[n]);const{updateContactClient:E}=z(),s=async a=>{if(!h())return new Promise((l,W)=>{E.mutateAsync({clientId:n.client_id,contactId:n.id,...a,description:a.description===""?null:a.description}).then(()=>{x(),U("Contacto atualizado com sucesso!"),l()}).catch(X=>{if(X.error.code==="CLI-004")return F("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"}),W();x(),H("Erro ao atualizar contacto!"),W()})})},o=q({control:r,name:"type"});return e.jsx(k,{mode:"form",title:"Editar Contacto",open:m,onClose:x,submitButtonText:"Editar Contacto",onSubmit:T(s),disabled:h(),children:e.jsx(L,{sx:{padding:3,paddingTop:1},children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,children:e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"type",control:r,render:({field:a})=>{var l;return e.jsx(V,{ref:a.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:a.value,onChange:a.onChange,error:!!c.type,helperText:(l=c.type)==null?void 0:l.message,inputRef:f})}})})}),e.jsx(M,{item:!0,xs:12,children:o==="E-mail"?e.jsx(_,{fullWidth:!0,children:e.jsx(O,{...y("contact"),label:"E-mail",error:!!c.contact,helperText:(t=c.contact)==null?void 0:t.message,autoComplete:"off",InputLabelProps:{shrink:((u=i("contact"))==null?void 0:u.length)>0}})}):e.jsx(e.Fragment,{children:o==="Telefone"||o==="Telemóvel"?e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"contact",control:r,render:({field:a})=>{var l;return e.jsx(K,{...a,value:C.type==="Telefone"||C.type==="Telemóvel"?a.value:"+351",onChange:W=>{a.onChange(W.replace(/\s+/g,""))},defaultCountry:"pt",label:o,variant:"outlined",fullWidth:!0,error:!!c.contact,helperText:(l=c.contact)==null?void 0:l.message,autoComplete:"off",disableDropdown:!0})}})}):e.jsx(_,{fullWidth:!0,children:e.jsx(O,{...y("contact"),label:"Contacto",error:!!c.contact,helperText:(v=c.contact)==null?void 0:v.message,autoComplete:"off",InputLabelProps:{shrink:((g=i("contact"))==null?void 0:g.length)>0}})})})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(D,{name:"description",control:r,render:({field:a})=>e.jsx($,{label:"Descrição",value:a.value,onChange:a.onChange})})})]})})})},he=({client:n,isLoading:m,isError:x})=>{var o;const f=!m&&!x,{role:r}=Y(),{deleteContactClient:y}=z(),[T,i]=S.useState({isOpen:!1,clientContact:null}),c=t=>{i({isOpen:!0,clientContact:t})},F=()=>{i({isOpen:!1,clientContact:null})},[j,C]=S.useState({isOpen:!1,clientContact:null}),b=t=>{C({isOpen:!0,clientContact:t})},h=()=>{C({isOpen:!1,clientContact:null})},E=()=>new Promise((t,u)=>{j.clientContact?y.mutateAsync({clientId:j.clientContact.client_id,contactId:j.clientContact.id}).then(()=>{h(),t()}).catch(()=>{h(),u()}):(h(),u())}),s=S.useMemo(()=>[{id:"type",label:"Tipo",align:"left",sortable:!0},{id:"contact",label:"Contacto",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsxs(d,{sx:{flexDirection:"row",alignItems:"center",gap:1},children:[e.jsx(e.Fragment,{children:me(t==null?void 0:t.contact)}),(t==null?void 0:t.description)&&e.jsx(w,{fontSize:"small",title:t==null?void 0:t.description})]})},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>{var u,v,g,a,l;return e.jsx(e.Fragment,{children:e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(A,{alt:(u=t==null?void 0:t.created_by_user)==null?void 0:u.username,src:`${B}/users/${(v=t==null?void 0:t.created_by_user)==null?void 0:v.id}/avatar?size=80`,name:(g=t==null?void 0:t.created_by_user)==null?void 0:g.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:(a=t==null?void 0:t.created_by_user)==null?void 0:a.username}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:(l=t==null?void 0:t.created_by_user)==null?void 0:l.role})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(I,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:P(t==null?void 0:t.created_at_datetime)}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:R(t==null?void 0:t.created_at_datetime)})]})]})})}},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>{var u,v,g,a,l;return e.jsx(e.Fragment,{children:t!=null&&t.last_modified_datetime?e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t!=null&&t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(A,{alt:(u=t==null?void 0:t.last_modified_by_user)==null?void 0:u.username,src:`${B}/users/${(v=t==null?void 0:t.last_modified_by_user)==null?void 0:v.id}/avatar?size=80`,name:(g=t==null?void 0:t.last_modified_by_user)==null?void 0:g.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:(a=t==null?void 0:t.last_modified_by_user)==null?void 0:a.username}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:(l=t==null?void 0:t.last_modified_by_user)==null?void 0:l.role})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(I,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(p,{variant:"p",component:"p",fontWeight:500,children:P(t==null?void 0:t.last_modified_datetime)}),e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:R(t==null?void 0:t.last_modified_datetime)})]})]}):e.jsx(p,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})}},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(ee,{mode:"custom",customButton:e.jsx(te,{title:"Mais opções",sx:{margin:-1},children:e.jsx(ae,{children:e.jsx(ue,{})})}),children:e.jsx(ne,{buttons:[{label:"Editar",icon:e.jsx(pe,{fontSize:"small"}),onClick:()=>c(t)},...r!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(se,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>b(t)}]:[]]})})}],[]);return e.jsxs(d,{children:[e.jsx(N,{title:"Contactos",description:"Contactos do cliente",icon:e.jsx(Q,{})}),e.jsx(oe,{isLoading:!f,LoadingComponent:e.jsx(ie,{mode:"datatable"}),LoadedComponent:e.jsx(L,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(le,{mode:"datatable",data:f?(o=n[0])==null?void 0:o.contacts:[],columns:s})})}),e.jsx(I,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(xe,{clientContact:T.clientContact,open:T.isOpen,onClose:F}),e.jsx(k,{mode:"delete",title:"Eliminar Contacto",open:j.isOpen,onClose:h,onSubmit:E,description:"Tem a certeza que deseja eliminar este contacto?",subDescription:"Ao eliminar este contacto, os dados serão removidos de forma permanente."})]})},fe=({client:n,isLoading:m,isError:x})=>{var h,E;const f=!m&&!x,{control:r,register:y,handleSubmit:T,formState:{errors:i},setError:c,reset:F}=G({resolver:J(Z)}),{addNewContactClient:j}=z(),C=async s=>{f&&await j.mutateAsync({clientId:n[0].id,...s,description:s.description===""?null:s.description}).then(()=>{F(),U("Contacto adicionado com sucesso!")}).catch(o=>{if(o.error.code==="CLI-002"){c("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"});return}H("Erro ao adicionar contacto!")})},b=q({control:r,name:"type"});return e.jsxs(d,{children:[e.jsx(N,{title:"Contacto",description:"Adicionar novo contacto ao cliente",icon:e.jsx(Q,{})}),e.jsx("form",{onSubmit:T(C),children:e.jsxs(d,{sx:{padding:3,gap:2},children:[e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"type",control:r,defaultValue:"",render:({field:s})=>{var o;return e.jsx(V,{ref:s.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:s.value,onChange:s.onChange,error:!!i.type,helperText:(o=i.type)==null?void 0:o.message})}})}),b==="E-mail"?e.jsx(_,{fullWidth:!0,children:e.jsx(O,{...y("contact"),label:"E-mail",error:!!i.contact,helperText:(h=i.contact)==null?void 0:h.message,autoComplete:"off"})}):e.jsx(e.Fragment,{children:b==="Telefone"||b==="Telemóvel"?e.jsx(_,{fullWidth:!0,children:e.jsx(D,{name:"contact",control:r,defaultValue:"+351",render:({field:s})=>{var o;return e.jsx(K,{...s,value:s.value||"+351",defaultCountry:"pt",label:b,variant:"outlined",fullWidth:!0,error:!!i.contact,helperText:(o=i.contact)==null?void 0:o.message,autoComplete:"off",disableDropdown:!0})}})}):e.jsx(_,{fullWidth:!0,children:e.jsx(O,{...y("contact"),label:"Contacto",error:!!i.contact,helperText:(E=i.contact)==null?void 0:E.message,autoComplete:"off"})})}),e.jsx(D,{name:"description",control:r,defaultValue:"",render:({field:s})=>e.jsx($,{label:"Descrição",value:s.value,onChange:s.onChange})}),e.jsx(L,{sx:{marginLeft:"auto",marginTop:1},children:e.jsx(re,{loading:j.isPending,type:"submit",variant:"contained",disabled:!f,children:"Adicionar Contacto"})})]})})]})},Fe=({client:n,isLoading:m,isError:x})=>e.jsxs(ce,{elevation:1,children:[e.jsx(he,{client:n,isLoading:m,isError:x}),e.jsx(fe,{client:n,isLoading:m,isError:x})]});export{Fe as default};
