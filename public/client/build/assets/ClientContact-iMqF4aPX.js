import{X as P,a4 as R,r as T,j as e,az as k,B as F,ad as S,a0 as v,a8 as E,aE as V,a1 as D,bl as U,aa as $,a5 as H,S as Y,Z as i,an as Z,Y as d,au as I,av as L,aF as w,ab as K,ah as Q,ai as ee,ac as te,aw as ae,aA as J,ax as oe,ay as re,ae as ne,a3 as se,a as ie}from"./index-BzXGUPkY.js";import{u as M}from"./useClient-CPTGHj4z.js";import{a as N}from"./client--QYkcLAJ.js";import{R as q,s as W}from"./sanitizeHTML-C6wbY_ne.js";import{f as A,a as B}from"./date-UO0O52K_.js";import{f as le}from"./phone-d4Gopd80.js";import{M as ce}from"./MoreVert-DdwSIp8d.js";import{E as de}from"./Edit-Djdsgm-9.js";import{P as G}from"./Phone-Icaa9BFK.js";const me=({clientContact:a,open:l,onClose:m})=>{var b,t,s,O;const{control:u,register:h,handleSubmit:_,formState:{errors:r},setError:n,reset:C,watch:f}=P({resolver:R(N),defaultValues:{type:(a==null?void 0:a.type)||"",contact:(a==null?void 0:a.contact)||"",description:(a==null?void 0:a.description)||""}}),{updateContactClient:j}=M(),p=T.useRef(null);T.useEffect(()=>{if(!l)return;const o=setTimeout(()=>{l&&p.current&&p.current.focus()},100);return()=>clearTimeout(o)},[l]);const y=()=>{const o=f();return o.type===(a==null?void 0:a.type)&&o.contact.replace(/\s+/g,"")===(a==null?void 0:a.contact)&&(W(o.description)===""?null:o.description)===(a==null?void 0:a.description)};T.useEffect(()=>{a&&C({type:a.type||"",contact:a.contact||"",description:a.description||""})},[a,C]);const c=async o=>{if(!y())return new Promise((g,z)=>{j.mutateAsync({clientId:a.client_id,contactId:a.id,...o,description:W(o.description)===""?null:o.description}).then(()=>{m(),$("Contacto atualizado com sucesso!"),g()}).catch(X=>{if(X.error.code==="CLI-004")return n("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"}),z();m(),H("Erro ao atualizar contacto!"),z()})})},x=f("type","");return e.jsx(k,{mode:"form",title:"Editar Contacto",open:l,onClose:m,submitButtonText:"Editar Contacto",onSubmit:_(c),disabled:y(),children:e.jsx(F,{sx:{padding:3,paddingTop:1},children:e.jsxs(S,{container:!0,spacing:2,children:[e.jsx(S,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"type",control:u,render:({field:o})=>{var g;return e.jsx(V,{ref:o.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:o.value,onChange:o.onChange,error:!!r.type,helperText:(g=r.type)==null?void 0:g.message,inputRef:p})}})})}),e.jsx(S,{item:!0,xs:12,children:x==="E-mail"?e.jsx(v,{fullWidth:!0,children:e.jsx(D,{...h("contact"),label:"E-mail",error:!!r.contact,helperText:(b=r.contact)==null?void 0:b.message,InputLabelProps:{shrink:((t=f("contact"))==null?void 0:t.length)>0}})}):e.jsx(e.Fragment,{children:x==="Telefone"||x==="Telemóvel"?e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:u,render:({field:o})=>{var g;return e.jsx(U,{...o,value:o.value||"+351",defaultCountry:"pt",label:x,variant:"outlined",fullWidth:!0,error:!!r.contact,helperText:(g=r.contact)==null?void 0:g.message,disableDropdown:!0})}})}):e.jsx(v,{fullWidth:!0,children:e.jsx(D,{...h("contact"),label:"Contacto",error:!!r.contact,helperText:(s=r.contact)==null?void 0:s.message,InputLabelProps:{shrink:((O=f("contact"))==null?void 0:O.length)>0}})})})}),e.jsx(S,{item:!0,xs:12,children:e.jsx(E,{name:"description",control:u,render:({field:o})=>e.jsx(q,{label:"Descrição",value:o.value,onChange:o.onChange})})})]})})})},ue=({client:a,isLoading:l,isError:m})=>{const u=!l&&!m,{role:h}=Y(),{deleteContactClient:_}=M(),[r,n]=T.useState({isOpen:!1,clientContact:null}),C=t=>{n({isOpen:!0,clientContact:t})},f=()=>{n({isOpen:!1,clientContact:null})},[j,p]=T.useState({isOpen:!1,clientContact:null}),y=t=>{p({isOpen:!0,clientContact:t})},c=()=>{p({isOpen:!1,clientContact:null})},x=()=>new Promise((t,s)=>{j.clientContact?_.mutateAsync({clientId:j.clientContact.client_id,contactId:j.clientContact.id}).then(()=>{c(),t()}).catch(()=>{c(),s()}):(c(),s())}),b=T.useMemo(()=>[{id:"type",label:"Tipo",align:"left",sortable:!0},{id:"contact",label:"Contacto",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsxs(i,{sx:{flexDirection:"row",alignItems:"center",gap:1},children:[e.jsx(e.Fragment,{children:le(t.contact)}),t.description&&e.jsx(Z,{fontSize:"small",title:t.description,isHtml:!0})]})},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:e.jsxs(i,{sx:{flexDirection:"row",gap:2},children:[e.jsx(i,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(I,{alt:t.created_by_user.username,src:`${L}/users/${t.created_by_user.id}/avatar?size=80`,name:t.created_by_user.username}),e.jsxs(i,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(d,{variant:"p",component:"p",fontWeight:500,children:t.created_by_user.username}),e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:t.created_by_user.role})]})]}):e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(i,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(d,{variant:"p",component:"p",fontWeight:500,children:A(t.created_at_datetime)}),e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:B(t.created_at_datetime)})]})]})})},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:t.last_modified_datetime?e.jsxs(i,{sx:{flexDirection:"row",gap:2},children:[e.jsx(i,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(I,{alt:t.last_modified_by_user.username,src:`${L}/users/${t.last_modified_by_user.id}/avatar?size=80`,name:t.last_modified_by_user.username}),e.jsxs(i,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(d,{variant:"p",component:"p",fontWeight:500,children:t.last_modified_by_user.username}),e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:t.last_modified_by_user.role})]})]}):e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(i,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(d,{variant:"p",component:"p",fontWeight:500,children:A(t.last_modified_datetime)}),e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:B(t.last_modified_datetime)})]})]}):e.jsx(d,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(K,{mode:"custom",customButton:e.jsx(Q,{title:"Mais opções",sx:{margin:-1},children:e.jsx(ee,{children:e.jsx(ce,{})})}),children:e.jsx(te,{buttons:[{label:"Editar",icon:e.jsx(de,{fontSize:"small"}),onClick:()=>C(t)},...h!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(ae,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>y(t)}]:[]]})})}],[]);return e.jsxs(i,{children:[e.jsx(J,{title:"Contactos",description:"Contactos do cliente",icon:e.jsx(G,{})}),e.jsx(oe,{isLoading:!u,LoadingComponent:e.jsx(re,{mode:"datatable"}),LoadedComponent:e.jsx(F,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(ne,{mode:"datatable",data:u?a[0].contacts:[],columns:b})})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(me,{clientContact:r.clientContact,open:r.isOpen,onClose:f}),e.jsx(k,{mode:"delete",title:"Eliminar Contacto",open:j.isOpen,onClose:c,onSubmit:x,description:"Tem a certeza que deseja eliminar este contacto?",subDescription:"Ao eliminar este contacto, os dados serão removidos de forma permanente."})]})},pe=({client:a,isLoading:l,isError:m})=>{var x,b;const u=!l&&!m,{control:h,register:_,handleSubmit:r,formState:{errors:n},setError:C,watch:f,reset:j}=P({resolver:R(N)}),{addNewContactClient:p}=M(),y=async t=>{u&&await p.mutateAsync({clientId:a[0].id,...t,description:W(t.description)===""?null:t.description}).then(()=>{j(),$("Contacto adicionado com sucesso!")}).catch(s=>{if(s.error.code==="CLI-002"){C("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"});return}H("Erro ao adicionar contacto!")})},c=f("type","");return e.jsxs(i,{children:[e.jsx(J,{title:"Contacto",description:"Adicionar novo contacto ao cliente",icon:e.jsx(G,{})}),e.jsx("form",{onSubmit:r(y),children:e.jsxs(i,{sx:{padding:3,gap:2},children:[e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"type",control:h,defaultValue:"",render:({field:t})=>{var s;return e.jsx(V,{ref:t.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:t.value,onChange:t.onChange,error:!!n.type,helperText:(s=n.type)==null?void 0:s.message})}})}),c==="E-mail"?e.jsx(v,{fullWidth:!0,children:e.jsx(D,{..._("contact"),label:"E-mail",error:!!n.contact,helperText:(x=n.contact)==null?void 0:x.message})}):e.jsx(e.Fragment,{children:c==="Telefone"||c==="Telemóvel"?e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:h,defaultValue:"+351",render:({field:t})=>{var s;return e.jsx(U,{...t,value:t.value||"+351",defaultCountry:"pt",label:c,variant:"outlined",fullWidth:!0,error:!!n.contact,helperText:(s=n.contact)==null?void 0:s.message,disableDropdown:!0})}})}):e.jsx(v,{fullWidth:!0,children:e.jsx(D,{..._("contact"),label:"Contacto",error:!!n.contact,helperText:(b=n.contact)==null?void 0:b.message})})}),e.jsx(E,{name:"description",control:h,defaultValue:"",render:({field:t})=>e.jsx(q,{label:"Descrição",value:t.value,onChange:t.onChange})}),e.jsx(F,{sx:{marginLeft:"auto",marginTop:1},children:e.jsx(se,{loading:p.isPending,type:"submit",variant:"contained",disabled:!u,children:"Adicionar Contacto"})})]})})]})},ye=({client:a,isLoading:l,isError:m})=>e.jsxs(ie,{elevation:1,children:[e.jsx(ue,{client:a,isLoading:l,isError:m}),e.jsx(pe,{client:a,isLoading:l,isError:m})]});export{ye as default};
