import{X as R,a4 as A,r as _,j as e,az as U,B as W,ad as x,a0 as p,a1 as h,Z as o,aa as $,a5 as J,S as X,Y as n,au as O,av as z,aF as L,ab as Y,ah as Z,ai as K,ac as ee,aw as te,aA as V,ax as ae,ay as se,ae as re,O as oe,at as ie,a3 as le,a as ne}from"./index-BzXGUPkY.js";import{u as w}from"./useClient-CPTGHj4z.js";import{b as q}from"./client--QYkcLAJ.js";import{f as k,a as B}from"./date-UO0O52K_.js";import{M as de}from"./MoreVert-DdwSIp8d.js";import{E as ce}from"./Edit-Djdsgm-9.js";import{P as G}from"./Place-cPpy2nG_.js";const ue=({clientAddress:a,open:i,onClose:d})=>{var m,y,g,t,b,T,E,I,D,P;const{register:l,handleSubmit:C,formState:{errors:r},setError:c,reset:v,watch:s}=R({resolver:A(q),defaultValues:{country:"",city:"",locality:"",address:"",postalCode:""}}),{updateAddressClient:M}=w(),u=_.useRef(null);_.useEffect(()=>{if(!i)return;const f=setTimeout(()=>{i&&u.current&&u.current.focus()},100);return()=>clearTimeout(f)},[i]),_.useEffect(()=>{a&&v({country:a.country||"",city:a.city||"",locality:a.locality||"",address:a.address||"",postalCode:a.postal_code||""})},[a]);const j=()=>{const f=s();return f.country===(a==null?void 0:a.country)&&f.city===(a==null?void 0:a.city)&&f.locality===(a==null?void 0:a.locality)&&f.address===(a==null?void 0:a.address)&&f.postalCode===(a==null?void 0:a.postal_code)},S=async f=>{if(!j())return new Promise((H,F)=>{M.mutateAsync({clientId:a.client_id,addressId:a.id,...f}).then(()=>{d(),$("Morada atualizada com sucesso!"),H()}).catch(N=>{if(N.error.code==="CLI-004")return["country","city","locality","address","postalCode"].forEach(Q=>{c(Q,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})}),F();d(),J("Erro ao atualizar morada!"),F()})})};return e.jsx(U,{mode:"form",title:"Editar Morada",open:i,onClose:d,submitButtonText:"Editar Morada",onSubmit:C(S),disabled:j(),children:e.jsx(W,{sx:{padding:3,paddingTop:1},children:e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...l("country"),label:"País",error:!!r.country,helperText:(m=r.country)==null?void 0:m.message,inputRef:u,InputLabelProps:{shrink:((y=s("country"))==null?void 0:y.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...l("city"),label:"Cidade",error:!!r.city,helperText:(g=r.city)==null?void 0:g.message,InputLabelProps:{shrink:((t=s("city"))==null?void 0:t.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...l("locality"),label:"Localidade",error:!!r.locality,helperText:(b=r.locality)==null?void 0:b.message,InputLabelProps:{shrink:((T=s("locality"))==null?void 0:T.length)>0}})})}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(o,{sx:{flexDirection:"column",gap:2},children:[e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...l("address"),label:"Morada",error:!!r.address,helperText:(E=r.address)==null?void 0:E.message,InputLabelProps:{shrink:((I=s("address"))==null?void 0:I.length)>0}})}),e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...l("postalCode"),label:"Código Postal",error:!!r.postalCode,helperText:(D=r.postalCode)==null?void 0:D.message,InputLabelProps:{shrink:((P=s("postalCode"))==null?void 0:P.length)>0}})})]})})]})})})},me=({client:a,isLoading:i,isError:d})=>{const l=!i&&!d,{role:C}=X(),{deleteAddressClient:r}=w(),[c,v]=_.useState({isOpen:!1,clientAddress:null}),s=t=>{v({isOpen:!0,clientAddress:t})},M=()=>{v({isOpen:!1,clientAddress:null})},[u,j]=_.useState({isOpen:!1,clientAddress:null}),S=t=>{j({isOpen:!0,clientAddress:t})},m=()=>{j({isOpen:!1,clientAddress:null})},y=()=>new Promise((t,b)=>{u.clientAddress?r.mutateAsync({clientId:u.clientAddress.client_id,addressId:u.clientAddress.id}).then(()=>{m(),t()}).catch(()=>{m(),b()}):(m(),b())}),g=_.useMemo(()=>[{id:"country",label:"País",align:"left",sortable:!0},{id:"city",label:"Cidade",align:"left",sortable:!0},{id:"locality",label:"Localidade",align:"left",sortable:!0},{id:"address",label:"Morada",align:"left",sortable:!0},{id:"postal_code",label:"Código postal",align:"left",sortable:!0},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:e.jsxs(o,{sx:{flexDirection:"row",gap:2},children:[e.jsx(o,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(O,{alt:t.created_by_user.username,src:`${z}/users/${t.created_by_user.id}/avatar?size=80`,name:t.created_by_user.username}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(n,{variant:"p",component:"p",fontWeight:500,children:t.created_by_user.username}),e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:t.created_by_user.role})]})]}):e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(n,{variant:"p",component:"p",fontWeight:500,children:k(t.created_at_datetime)}),e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:B(t.created_at_datetime)})]})]})})},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:t.last_modified_datetime?e.jsxs(o,{sx:{flexDirection:"row",gap:2},children:[e.jsx(o,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(O,{alt:t.last_modified_by_user.username,src:`${z}/users/${t.last_modified_by_user.id}/avatar?size=80`,name:t.last_modified_by_user.username}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(n,{variant:"p",component:"p",fontWeight:500,children:t.last_modified_by_user.username}),e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:t.last_modified_by_user.role})]})]}):e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(n,{variant:"p",component:"p",fontWeight:500,children:k(t.last_modified_datetime)}),e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:B(t.last_modified_datetime)})]})]}):e.jsx(n,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})},{id:"more_options",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(Y,{mode:"custom",customButton:e.jsx(Z,{title:"Mais opções",sx:{margin:-1},children:e.jsx(K,{children:e.jsx(de,{})})}),children:e.jsx(ee,{buttons:[{label:"Editar",icon:e.jsx(ce,{fontSize:"small"}),onClick:()=>s(t)},...C!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(te,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>S(t)}]:[]]})})}],[]);return e.jsxs(o,{children:[e.jsx(V,{title:"Moradas",description:"Moradas do cliente",icon:e.jsx(G,{})}),e.jsx(ae,{isLoading:!l,LoadingComponent:e.jsx(se,{mode:"datatable"}),LoadedComponent:e.jsx(W,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(re,{mode:"datatable",data:l?a[0].addresses:[],columns:g})})}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(ue,{clientAddress:c.clientAddress,open:c.isOpen,onClose:M}),e.jsx(U,{mode:"delete",title:"Eliminar Morada",open:u.isOpen,onClose:m,onSubmit:y,description:"Tem a certeza que deseja eliminar esta morada?",subDescription:"Ao eliminar esta morada, os dados serão removidos de forma permanente."})]})},xe=({client:a,isLoading:i,isError:d})=>{var m,y,g,t,b;const l=!i&&!d,C=oe(),r=ie(C.breakpoints.down("sm")),{register:c,handleSubmit:v,formState:{errors:s},setError:M,reset:u}=R({resolver:A(q)}),{addNewAddressClient:j}=w(),S=async T=>{l&&await j.mutateAsync({clientId:a[0].id,...T}).then(()=>{u(),$("Morada adicionada com sucesso!")}).catch(E=>{if(E.error.code==="CLI-004"){["country","city","locality","address","postalCode"].forEach(D=>{M(D,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})});return}J("Erro ao adicionar morada!")})};return e.jsxs(o,{children:[e.jsx(V,{title:"Morada",description:"Adicionar nova morada ao cliente",icon:e.jsx(G,{})}),e.jsx("form",{onSubmit:v(S),children:e.jsxs(o,{children:[e.jsxs(x,{container:!0,spacing:2,sx:{paddingInline:3},children:[e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...c("country"),label:"País",error:!!s.country,helperText:(m=s.country)==null?void 0:m.message})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...c("city"),label:"Cidade",error:!!s.city,helperText:(y=s.city)==null?void 0:y.message})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...c("locality"),label:"Localidade",error:!!s.locality,helperText:(g=s.locality)==null?void 0:g.message})})}),e.jsx(x,{item:!0,xs:12,md:12,lg:6,children:e.jsxs(o,{sx:{flexDirection:r?"column":"row",gap:2},children:[e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...c("address"),label:"Morada",error:!!s.address,helperText:(t=s.address)==null?void 0:t.message})}),e.jsx(p,{fullWidth:!0,children:e.jsx(h,{...c("postalCode"),label:"Código Postal",error:!!s.postalCode,helperText:(b=s.postalCode)==null?void 0:b.message})})]})})]}),e.jsx(W,{sx:{marginLeft:"auto",padding:3},children:e.jsx(le,{loading:j.isPending,type:"submit",variant:"contained",disabled:!l,children:"Adicionar Morada"})})]})})]})},_e=({client:a,isLoading:i,isError:d})=>e.jsxs(ne,{elevation:1,children:[e.jsx(me,{client:a,isLoading:i,isError:d}),e.jsx(xe,{client:a,isLoading:i,isError:d})]});export{_e as default};
