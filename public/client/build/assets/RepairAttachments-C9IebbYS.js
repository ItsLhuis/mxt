import{e as P,r as g,j as t,S as a,b5 as $,b6 as W,b7 as k,h as s,aF as E,aG as F,aI as R,aJ as N,aK as U,aM as D,ah as T,aL as q,aN as H,aO as K,aP as G,H as z,aR as J,aS as Q,B as V,aT as X,b8 as Y,aU as Z,bB as w,L as ee,f as te}from"./index-_NktdslD.js";import{u as M}from"./useRepair-MRRzMLfz.js";import{V as ae}from"./Visibility-DFwPaxnL.js";import{A as B}from"./Attachment-mpytDbBq.js";import{u as ie,t as ne,C as se}from"./index-8QsUXVhp.js";import{b as le}from"./repair-j_MUsWAD.js";const re=({repair:l,isLoading:r,isError:o})=>{var y;const m=!r&&!o,{role:v}=P(),{deleteRepairAttachment:_}=M(),[c,p]=g.useState(!1),[i,x]=g.useState({url:"",name:"",size:"",type:""}),d=(e,n,j,b)=>{x({url:e,name:n,size:j,type:b}),p(!0)},h=()=>{p(!1),x({url:"",type:""})},[u,A]=g.useState({isOpen:!1,repairAttachment:null}),L=e=>{A({isOpen:!0,repairAttachment:e})},f=()=>{A({isOpen:!1,repairAttachment:null})},O=()=>new Promise((e,n)=>{u.repairAttachment?_.mutateAsync({repairId:u.repairAttachment.repair_id,attachmentId:u.repairAttachment.id}).then(()=>{f(),e()}).catch(()=>{f(),n()}):(f(),n())}),I=g.useMemo(()=>[{id:"file_mime_type",label:"Tipo",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsx(a,{sx:{alignItems:"flex-start"},children:(e==null?void 0:e.file_mime_type)==="application/pdf"?t.jsx("img",{src:$}):e!=null&&e.file_mime_type.startsWith("image/")?t.jsx("img",{src:W}):t.jsx("img",{src:k})})},{id:"original_filename",label:"Ficheiro",align:"left",sortable:!0,renderComponent:({row:e})=>t.jsxs(a,{children:[t.jsx(s,{variant:"p",component:"p",children:e==null?void 0:e.original_filename}),t.jsx(s,{variant:"p",component:"p",sx:{color:"var(--outline)"},children:`${(e==null?void 0:e.file_size)<1024*1024?((e==null?void 0:e.file_size)/1024).toFixed(2)+" Kb":((e==null?void 0:e.file_size)/(1024*1024)).toFixed(2)+" Mb"}`})]})},{id:"uploaded_by_user",visible:!1},{id:"uploaded_at_datetime",label:"Carregado por",align:"left",sortable:!0,renderComponent:({row:e})=>{var n,j,b,S,C;return t.jsx(t.Fragment,{children:t.jsxs(a,{sx:{flexDirection:"row",gap:2},children:[t.jsx(a,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:e!=null&&e.uploaded_by_user?t.jsxs(t.Fragment,{children:[t.jsx(E,{alt:(n=e==null?void 0:e.uploaded_by_user)==null?void 0:n.username,src:`${F}/users/${(j=e==null?void 0:e.uploaded_by_user)==null?void 0:j.id}/avatar?size=80`,name:(b=e==null?void 0:e.uploaded_by_user)==null?void 0:b.username}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:(S=e==null?void 0:e.uploaded_by_user)==null?void 0:S.username}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:(C=e==null?void 0:e.uploaded_by_user)==null?void 0:C.role})]})]}):t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsxs(a,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[t.jsx(s,{variant:"p",component:"p",fontWeight:500,children:N(e==null?void 0:e.uploaded_at_datetime)}),t.jsx(s,{variant:"p",component:"p",color:"var(--outline)",children:U(e==null?void 0:e.uploaded_at_datetime)})]})]})})}},{id:"view_file",align:"right",sortable:!1,renderComponent:({row:e})=>t.jsx(D,{title:"Ver anexo",sx:{margin:-1},children:t.jsx(T,{onClick:()=>d(`${F}/repairs/${e==null?void 0:e.repair_id}/attachments/${e==null?void 0:e.id}/${e==null?void 0:e.original_filename}`,e==null?void 0:e.original_filename,e==null?void 0:e.file_size,e==null?void 0:e.file_mime_type),children:t.jsx(ae,{})})})},{id:"more_options",align:"right",sortable:!1,disablePadding:!0,renderComponent:({row:e})=>{if(v!=="Funcionário")return t.jsx(q,{mode:"custom",customButton:t.jsx(D,{title:"Mais opções",sx:{margin:-1},children:t.jsx(T,{children:t.jsx(H,{})})}),children:t.jsx(K,{buttons:[{label:"Eliminar",icon:t.jsx(G,{fontSize:"small",color:"error"}),color:"error",onClick:()=>L(e)}]})})}}],[]);return t.jsxs(a,{children:[t.jsx(z,{title:"Anexos",description:"Anexos do equipamento",icon:t.jsx(B,{})}),t.jsx(J,{isLoading:!m,LoadingComponent:t.jsx(Q,{mode:"datatable"}),LoadedComponent:t.jsx(V,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:t.jsx(X,{mode:"datatable",data:m?(y=l[0])==null?void 0:y.attachments:[],columns:I})})}),t.jsx(R,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),t.jsx(Y,{open:c,onClose:h,file:i.url,fileName:i.name,fileSize:Number(i.size),fileType:i.type}),t.jsx(Z,{mode:"delete",title:"Eliminar Anexo",open:u.isOpen,onClose:f,onSubmit:O,description:"Tem a certeza que deseja eliminar este anexo?",subDescription:"Ao eliminar este anexo, os dados serão removidos de forma permanente."})]})},oe=({repair:l,isLoading:r,isError:o})=>{const m=!r&&!o,{control:v,handleSubmit:_,formState:{errors:c},reset:p}=ie({resolver:ne(le),defaultValues:{attachments:[]}}),{addNewRepairAttachment:i}=M(),x=async d=>{m&&await i.mutateAsync({repairId:l[0].id,...d}).then(()=>p())};return t.jsxs(a,{children:[t.jsx(z,{title:"Anexos",description:"Adicionar novos anexos à reparação",icon:t.jsx(B,{})}),t.jsx("form",{onSubmit:_(x),children:t.jsxs(a,{sx:{padding:3,gap:3},children:[t.jsx(se,{name:"attachments",control:v,defaultValue:"",render:({field:d})=>{var h;return t.jsx(w,{disabled:i.isPending,value:d.value,onChange:d.onChange,error:!!c.attachments,helperText:(h=c.attachments)==null?void 0:h.message})}}),t.jsx(V,{sx:{marginLeft:"auto"},children:t.jsx(ee,{loading:i.isPending,type:"submit",variant:"contained",disabled:!m,children:"Adicionar Anexos"})})]})})]})},ue=({repair:l,isLoading:r,isError:o})=>t.jsxs(te,{elevation:1,children:[t.jsx(re,{repair:l,isLoading:r,isError:o}),t.jsx(oe,{repair:l,isLoading:r,isError:o})]});export{ue as default};
