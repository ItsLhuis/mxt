import{d as P,t as R,r as T,j as e,M as k,B as W,G as S,f as b,C as E,h as V,g as w,bg as $,s as G,aB as H,a4 as Q,S as c,at as A,au as F,l as x,D,A as X,T as Y,I as Z,E as ee,av as te,ay as J,az as oe,aA as ae,y as re,L as ne,a as se}from"./index-CeqpX1Nb.js";import{u as O}from"./useClient-BnfOapIz.js";import{a as N}from"./client-CvQStxuO.js";import{R as U,s as M}from"./sanitizeHTML-DKq6pAo9.js";import{f as z,a as B}from"./date-Cygk3yQx.js";import{f as ie}from"./phone-CUaemfYv.js";import{M as le}from"./MoreVert-2tfujLn5.js";import{E as ce}from"./Edit-DmtXJ-nr.js";import{P as q}from"./Phone-C3wTJmHb.js";const de=({clientContact:o,open:i,onClose:d})=>{var v,t,s,I;const{control:u,register:h,handleSubmit:C,formState:{errors:r},setError:n,reset:y,watch:f}=P({resolver:R(N),defaultValues:{type:(o==null?void 0:o.type)||"",contact:(o==null?void 0:o.contact)||"",description:(o==null?void 0:o.description)||""}}),{updateContactClient:j}=O(),m=T.useRef(null);T.useEffect(()=>{if(!i)return;const a=setTimeout(()=>{i&&m.current&&m.current.focus()},100);return()=>clearTimeout(a)},[i]);const _=()=>{const a=f();return a.type===(o==null?void 0:o.type)&&a.contact===(o==null?void 0:o.contact)&&(M(a.description)===""?null:a.description)===(o==null?void 0:o.description)};T.useEffect(()=>{o&&y({type:o.type||"",contact:o.contact||"",description:o.description||""})},[o,y]);const l=async a=>{if(!_())return new Promise((g,L)=>{j.mutateAsync({clientId:o.client_id,contactId:o.id,...a,description:M(a.description)===""?null:a.description}).then(()=>{d(),G("Contacto atualizado com sucesso!"),g()}).catch(K=>{if(K.error.code==="CLI-004")return n("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"}),L();d(),H("Erro ao atualizar contacto!"),L()})})},p=f("type","");return e.jsx(k,{mode:"form",title:"Editar Contacto",open:i,onClose:d,submitButtonText:"Editar Contacto",onSubmit:C(l),disabled:_(),children:e.jsx(W,{sx:{padding:3,paddingTop:1},children:e.jsxs(S,{container:!0,spacing:2,children:[e.jsx(S,{item:!0,xs:12,children:e.jsx(b,{fullWidth:!0,children:e.jsx(E,{name:"type",control:u,render:({field:a})=>{var g;return e.jsx(V,{ref:a.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:a.value,onChange:a.onChange,error:!!r.type,helperText:(g=r.type)==null?void 0:g.message,inputRef:m})}})})}),e.jsx(S,{item:!0,xs:12,children:p==="E-mail"?e.jsx(b,{fullWidth:!0,children:e.jsx(w,{...h("contact"),label:"E-mail",error:!!r.contact,helperText:(v=r.contact)==null?void 0:v.message,InputLabelProps:{shrink:((t=f("contact"))==null?void 0:t.length)>0}})}):e.jsx(e.Fragment,{children:p==="Telefone"||p==="Telemóvel"?e.jsx(b,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:u,render:({field:a})=>{var g;return e.jsx($,{...a,value:a.value||"+351",defaultCountry:"pt",label:p,variant:"outlined",fullWidth:!0,error:!!r.contact,helperText:(g=r.contact)==null?void 0:g.message,disableDropdown:!0})}})}):e.jsx(b,{fullWidth:!0,children:e.jsx(w,{...h("contact"),label:"Contacto",error:!!r.contact,helperText:(s=r.contact)==null?void 0:s.message,InputLabelProps:{shrink:((I=f("contact"))==null?void 0:I.length)>0}})})})}),e.jsx(S,{item:!0,xs:12,children:e.jsx(E,{name:"description",control:u,render:({field:a})=>e.jsx(U,{label:"Descrição",value:a.value,onChange:a.onChange})})})]})})})},ue=({client:o,isLoading:i,isError:d})=>{const u=!i&&!d,{role:h}=Q(),{deleteContactClient:C}=O(),[r,n]=T.useState({isOpen:!1,clientContact:null}),y=t=>{n({isOpen:!0,clientContact:t})},f=()=>{n({isOpen:!1,clientContact:null})},[j,m]=T.useState({isOpen:!1,clientContact:null}),_=t=>{m({isOpen:!0,clientContact:t})},l=()=>{m({isOpen:!1,clientContact:null})},p=()=>new Promise((t,s)=>{j.clientContact?C.mutateAsync({clientId:j.clientContact.client_id,contactId:j.clientContact.id}).then(()=>{l(),t()}).catch(()=>{l(),s()}):(l(),s())}),v=T.useMemo(()=>[{id:"type",label:"Tipo",align:"left",sortable:!0},{id:"contact",label:"Contacto",align:"left",sortable:!0,formatter:ie},{id:"created_by_user",label:"Criado por",align:"left",sortable:!1,renderComponent:({row:t})=>e.jsxs(c,{sx:{flexDirection:"row",gap:2},children:[e.jsxs(c,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:[e.jsx(A,{alt:t.created_by_user.username,src:`${F}/users/${t.created_by_user.id}/avatar?size=80`,name:t.created_by_user.username}),e.jsxs(c,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(x,{variant:"p",component:"p",fontWeight:500,children:t.created_by_user.username}),e.jsx(x,{variant:"p",component:"p",color:"var(--outline)",children:t.created_by_user.role})]})]}),e.jsx(D,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(c,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(x,{variant:"p",component:"p",fontWeight:500,children:z(t.created_at_datetime)}),e.jsx(x,{variant:"p",component:"p",color:"var(--outline)",children:B(t.created_at_datetime)})]})]})},{id:"last_modified_by_user",label:"Modificado pela última vez por",align:"left",sortable:!1,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:t.last_modified_by_user?e.jsxs(c,{sx:{flexDirection:"row",gap:2},children:[e.jsxs(c,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:[e.jsx(A,{alt:t.last_modified_by_user.username,src:`${F}/users/${t.last_modified_by_user.id}/avatar?size=80`,name:t.last_modified_by_user.username}),e.jsxs(c,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(x,{variant:"p",component:"p",fontWeight:500,children:t.last_modified_by_user.username}),e.jsx(x,{variant:"p",component:"p",color:"var(--outline)",children:t.last_modified_by_user.role})]})]}),e.jsx(D,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(c,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(x,{variant:"p",component:"p",fontWeight:500,children:z(t.last_modified_datetime)}),e.jsx(x,{variant:"p",component:"p",color:"var(--outline)",children:B(t.last_modified_datetime)})]})]}):e.jsx(x,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})},{id:"moreOptions",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(X,{mode:"custom",customButton:e.jsx(Y,{title:"Mais opções",placement:"bottom",sx:{margin:-1},children:e.jsx(Z,{children:e.jsx(le,{})})}),children:e.jsx(ee,{buttons:[{label:"Editar",icon:e.jsx(ce,{fontSize:"small"}),onClick:()=>y(t)},...h!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(te,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>_(t)}]:[]]})})}],[]);return e.jsxs(c,{children:[e.jsx(J,{title:"Contactos",description:"Contactos do cliente",icon:e.jsx(q,{})}),e.jsx(oe,{isLoading:!u,LoadingComponent:e.jsx(ae,{mode:"datatable"}),LoadedComponent:e.jsx(W,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(re,{mode:"datatable",data:u?o[0].contacts:[],columns:v})})}),e.jsx(D,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(de,{clientContact:r.clientContact,open:r.isOpen,onClose:f}),e.jsx(k,{mode:"delete",title:"Eliminar Contacto",open:j.isOpen,onClose:l,onSubmit:p,description:"Tem a certeza que deseja eliminar este contacto?",subDescription:"Ao eliminar este contacto, os dados serão removidos de forma permanente."})]})},me=({client:o,isLoading:i,isError:d})=>{var p,v;const u=!i&&!d,{control:h,register:C,handleSubmit:r,formState:{errors:n},setError:y,watch:f,reset:j}=P({resolver:R(N)}),{addNewContactClient:m}=O(),_=async t=>{u&&await m.mutateAsync({clientId:o[0].id,...t,description:M(t.description)===""?null:t.description}).then(()=>{j(),G("Contacto adicionado com sucesso!")}).catch(s=>{if(s.error.code==="CLI-002"){y("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"});return}H("Erro ao adicionar contacto!")})},l=f("type","");return e.jsxs(c,{children:[e.jsx(J,{title:"Contacto",description:"Adicionar novo contacto ao cliente",icon:e.jsx(q,{})}),e.jsx("form",{onSubmit:r(_),children:e.jsxs(c,{sx:{padding:3,gap:3},children:[e.jsx(b,{fullWidth:!0,children:e.jsx(E,{name:"type",control:h,defaultValue:"",render:({field:t})=>{var s;return e.jsx(V,{ref:t.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:t.value,onChange:t.onChange,error:!!n.type,helperText:(s=n.type)==null?void 0:s.message})}})}),l==="E-mail"?e.jsx(b,{fullWidth:!0,children:e.jsx(w,{...C("contact"),label:"E-mail",error:!!n.contact,helperText:(p=n.contact)==null?void 0:p.message})}):e.jsx(e.Fragment,{children:l==="Telefone"||l==="Telemóvel"?e.jsx(b,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:h,defaultValue:"+351",render:({field:t})=>{var s;return e.jsx($,{...t,value:t.value||"+351",defaultCountry:"pt",label:l,variant:"outlined",fullWidth:!0,error:!!n.contact,helperText:(s=n.contact)==null?void 0:s.message,disableDropdown:!0})}})}):e.jsx(b,{fullWidth:!0,children:e.jsx(w,{...C("contact"),label:"Contacto",error:!!n.contact,helperText:(v=n.contact)==null?void 0:v.message})})}),e.jsx(E,{name:"description",control:h,defaultValue:"",render:({field:t})=>e.jsx(U,{label:"Descrição",value:t.value,onChange:t.onChange})}),e.jsx(W,{sx:{marginLeft:"auto"},children:e.jsx(ne,{loading:m.isPending,type:"submit",variant:"contained",disabled:!u,children:"Adicionar Contacto"})})]})})]})},ye=({client:o,isLoading:i,isError:d})=>e.jsxs(se,{elevation:1,children:[e.jsx(ue,{client:o,isLoading:i,isError:d}),e.jsx(me,{client:o,isLoading:i,isError:d})]});export{ye as default};
