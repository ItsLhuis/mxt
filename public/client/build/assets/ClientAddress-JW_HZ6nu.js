import{d as A,t as R,r as C,j as e,M as $,B as w,G as m,f as x,g as p,S as o,s as q,aB as G,a4 as K,at as k,au as B,l as f,D as L,A as X,T as Y,I as Z,E as ee,av as te,ay as J,az as se,aA as ae,y as re,q as oe,v as le,L as ie,a as ne}from"./index-CeqpX1Nb.js";import{u as W}from"./useClient-BnfOapIz.js";import{b as U}from"./client-CvQStxuO.js";import{f as z,a as F}from"./date-Cygk3yQx.js";import{M as de}from"./MoreVert-2tfujLn5.js";import{E as ce}from"./Edit-DmtXJ-nr.js";import{P as V}from"./Place-WwDqjt_j.js";const ue=({clientAddress:t,open:l,onClose:n})=>{var u,y,g,s,b,T,E,I,D,P;const{register:i,handleSubmit:_,formState:{errors:r},setError:d,reset:v,watch:a}=A({resolver:R(U),defaultValues:{country:"",city:"",locality:"",address:"",postalCode:""}}),{updateAddressClient:M}=W(),c=C.useRef(null);C.useEffect(()=>{if(!l)return;const h=setTimeout(()=>{l&&c.current&&c.current.focus()},100);return()=>clearTimeout(h)},[l]),C.useEffect(()=>{t&&v({country:t.country||"",city:t.city||"",locality:t.locality||"",address:t.address||"",postalCode:t.postal_code||""})},[t]);const j=()=>{const h=a();return h.country===(t==null?void 0:t.country)&&h.city===(t==null?void 0:t.city)&&h.locality===(t==null?void 0:t.locality)&&h.address===(t==null?void 0:t.address)&&h.postalCode===(t==null?void 0:t.postal_code)},S=async h=>{if(!j())return new Promise((H,O)=>{M.mutateAsync({clientId:t.client_id,addressId:t.id,...h}).then(()=>{n(),q("Morada atualizada com sucesso!"),H()}).catch(N=>{if(N.error.code==="CLI-004")return["country","city","locality","address","postalCode"].forEach(Q=>{d(Q,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})}),O();n(),G("Erro ao atualizar morada!"),O()})})};return e.jsx($,{mode:"form",title:"Editar Morada",open:l,onClose:n,submitButtonText:"Editar Morada",onSubmit:_(S),disabled:j(),children:e.jsx(w,{sx:{padding:3,paddingTop:1},children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...i("country"),label:"País",error:!!r.country,helperText:(u=r.country)==null?void 0:u.message,inputRef:c,InputLabelProps:{shrink:((y=a("country"))==null?void 0:y.length)>0}})})}),e.jsx(m,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...i("city"),label:"Cidade",error:!!r.city,helperText:(g=r.city)==null?void 0:g.message,InputLabelProps:{shrink:((s=a("city"))==null?void 0:s.length)>0}})})}),e.jsx(m,{item:!0,xs:12,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...i("locality"),label:"Localidade",error:!!r.locality,helperText:(b=r.locality)==null?void 0:b.message,InputLabelProps:{shrink:((T=a("locality"))==null?void 0:T.length)>0}})})}),e.jsx(m,{item:!0,xs:12,children:e.jsxs(o,{sx:{flexDirection:"column",gap:2},children:[e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...i("address"),label:"Morada",error:!!r.address,helperText:(E=r.address)==null?void 0:E.message,InputLabelProps:{shrink:((I=a("address"))==null?void 0:I.length)>0}})}),e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...i("postalCode"),label:"Código Postal",error:!!r.postalCode,helperText:(D=r.postalCode)==null?void 0:D.message,InputLabelProps:{shrink:((P=a("postalCode"))==null?void 0:P.length)>0}})})]})})]})})})},me=({client:t,isLoading:l,isError:n})=>{const i=!l&&!n,{role:_}=K(),{deleteAddressClient:r}=W(),[d,v]=C.useState({isOpen:!1,clientAddress:null}),a=s=>{v({isOpen:!0,clientAddress:s})},M=()=>{v({isOpen:!1,clientAddress:null})},[c,j]=C.useState({isOpen:!1,clientAddress:null}),S=s=>{j({isOpen:!0,clientAddress:s})},u=()=>{j({isOpen:!1,clientAddress:null})},y=()=>new Promise((s,b)=>{c.clientAddress?r.mutateAsync({clientId:c.clientAddress.client_id,addressId:c.clientAddress.id}).then(()=>{u(),s()}).catch(()=>{u(),b()}):(u(),b())}),g=C.useMemo(()=>[{id:"country",label:"País",align:"left",sortable:!0},{id:"city",label:"Cidade",align:"left",sortable:!0},{id:"locality",label:"Localidade",align:"left",sortable:!0},{id:"address",label:"Morada",align:"left",sortable:!0},{id:"postal_code",label:"Código postal",align:"left",sortable:!0},{id:"created_by_user",label:"Criado por",align:"left",sortable:!1,renderComponent:({row:s})=>e.jsxs(o,{sx:{flexDirection:"row",gap:2},children:[e.jsxs(o,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:[e.jsx(k,{alt:s.created_by_user.username,src:`${B}/users/${s.created_by_user.id}/avatar?size=80`,name:s.created_by_user.username}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(f,{variant:"p",component:"p",fontWeight:500,children:s.created_by_user.username}),e.jsx(f,{variant:"p",component:"p",color:"var(--outline)",children:s.created_by_user.role})]})]}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(f,{variant:"p",component:"p",fontWeight:500,children:z(s.created_at_datetime)}),e.jsx(f,{variant:"p",component:"p",color:"var(--outline)",children:F(s.created_at_datetime)})]})]})},{id:"last_modified_by_user",label:"Modificado pela última vez por",align:"left",sortable:!1,renderComponent:({row:s})=>e.jsx(e.Fragment,{children:s.last_modified_by_user?e.jsxs(o,{sx:{flexDirection:"row",gap:2},children:[e.jsxs(o,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:[e.jsx(k,{alt:s.last_modified_by_user.username,src:`${B}/users/${s.last_modified_by_user.id}/avatar?size=80`,name:s.last_modified_by_user.username}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(f,{variant:"p",component:"p",fontWeight:500,children:s.last_modified_by_user.username}),e.jsx(f,{variant:"p",component:"p",color:"var(--outline)",children:s.last_modified_by_user.role})]})]}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(o,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(f,{variant:"p",component:"p",fontWeight:500,children:z(s.last_modified_datetime)}),e.jsx(f,{variant:"p",component:"p",color:"var(--outline)",children:F(s.last_modified_datetime)})]})]}):e.jsx(f,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})},{id:"moreOptions",align:"right",sortable:!1,renderComponent:({row:s})=>e.jsx(X,{mode:"custom",customButton:e.jsx(Y,{title:"Mais opções",placement:"bottom",sx:{margin:-1},children:e.jsx(Z,{children:e.jsx(de,{})})}),children:e.jsx(ee,{buttons:[{label:"Editar",icon:e.jsx(ce,{fontSize:"small"}),onClick:()=>a(s)},..._!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(te,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>S(s)}]:[]]})})}],[]);return e.jsxs(o,{children:[e.jsx(J,{title:"Moradas",description:"Moradas do cliente",icon:e.jsx(V,{})}),e.jsx(se,{isLoading:!i,LoadingComponent:e.jsx(ae,{mode:"datatable"}),LoadedComponent:e.jsx(w,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(re,{mode:"datatable",data:i?t[0].addresses:[],columns:g})})}),e.jsx(L,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(ue,{clientAddress:d.clientAddress,open:d.isOpen,onClose:M}),e.jsx($,{mode:"delete",title:"Eliminar Morada",open:c.isOpen,onClose:u,onSubmit:y,description:"Tem a certeza que deseja eliminar esta morada?",subDescription:"Ao eliminar esta morada, os dados serão removidos de forma permanente."})]})},xe=({client:t,isLoading:l,isError:n})=>{var u,y,g,s,b;const i=!l&&!n,_=oe(),r=le(_.breakpoints.down("sm")),{register:d,handleSubmit:v,formState:{errors:a},setError:M,reset:c}=A({resolver:R(U)}),{addNewAddressClient:j}=W(),S=async T=>{i&&await j.mutateAsync({clientId:t[0].id,...T}).then(()=>{c(),q("Morada adicionada com sucesso!")}).catch(E=>{if(E.error.code==="CLI-004"){["country","city","locality","address","postalCode"].forEach(D=>{M(D,{type:"manual",message:"Já existe uma morada com os mesmos valores para este cliente"})});return}G("Erro ao adicionar morada!")})};return e.jsxs(o,{children:[e.jsx(J,{title:"Morada",description:"Adicionar nova morada ao cliente",icon:e.jsx(V,{})}),e.jsx("form",{onSubmit:v(S),children:e.jsxs(o,{children:[e.jsxs(m,{container:!0,spacing:2,sx:{paddingInline:3},children:[e.jsx(m,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...d("country"),label:"País",error:!!a.country,helperText:(u=a.country)==null?void 0:u.message})})}),e.jsx(m,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...d("city"),label:"Cidade",error:!!a.city,helperText:(y=a.city)==null?void 0:y.message})})}),e.jsx(m,{item:!0,xs:12,md:12,lg:6,children:e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...d("locality"),label:"Localidade",error:!!a.locality,helperText:(g=a.locality)==null?void 0:g.message})})}),e.jsx(m,{item:!0,xs:12,md:12,lg:6,children:e.jsxs(o,{sx:{flexDirection:r?"column":"row",gap:2},children:[e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...d("address"),label:"Morada",error:!!a.address,helperText:(s=a.address)==null?void 0:s.message})}),e.jsx(x,{fullWidth:!0,children:e.jsx(p,{...d("postalCode"),label:"Código Postal",error:!!a.postalCode,helperText:(b=a.postalCode)==null?void 0:b.message})})]})})]}),e.jsx(w,{sx:{marginLeft:"auto",padding:3},children:e.jsx(ie,{loading:j.isPending,type:"submit",variant:"contained",disabled:!i,children:"Adicionar Morada"})})]})})]})},Ce=({client:t,isLoading:l,isError:n})=>e.jsxs(ne,{elevation:1,children:[e.jsx(me,{client:t,isLoading:l,isError:n}),e.jsx(xe,{client:t,isLoading:l,isError:n})]});export{Ce as default};
