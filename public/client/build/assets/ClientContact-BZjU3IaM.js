import{X as P,a3 as R,r as T,j as e,ay as k,B as M,ac as S,$ as v,a7 as E,aD as V,a0 as D,bi as $,a9 as U,a4 as H,S as Y,Z as d,Y as c,at as I,au as L,aE as w,aa as Z,ag as K,ah as Q,ab as ee,av as te,az as J,aw as ae,ax as oe,ad as re,a2 as ne,a as se}from"./index-DjYwzy8o.js";import{u as O}from"./useClient-u94t69cI.js";import{a as N}from"./client-Ce6SMqAF.js";import{R as q,s as W}from"./sanitizeHTML-BJ4gd8Xw.js";import{f as A,a as B}from"./date-CpdtD0wQ.js";import{f as ie}from"./phone-CpiNNUiR.js";import{M as le}from"./MoreVert-DQhEmQ3X.js";import{E as ce}from"./Edit-BByoqxOd.js";import{P as G}from"./Phone-D-5Xro_p.js";const de=({clientContact:a,open:i,onClose:u})=>{var b,t,s,F;const{control:m,register:h,handleSubmit:_,formState:{errors:r},setError:n,reset:C,watch:f}=P({resolver:R(N),defaultValues:{type:(a==null?void 0:a.type)||"",contact:(a==null?void 0:a.contact)||"",description:(a==null?void 0:a.description)||""}}),{updateContactClient:j}=O(),p=T.useRef(null);T.useEffect(()=>{if(!i)return;const o=setTimeout(()=>{i&&p.current&&p.current.focus()},100);return()=>clearTimeout(o)},[i]);const y=()=>{const o=f();return o.type===(a==null?void 0:a.type)&&o.contact.replace(/\s+/g,"")===(a==null?void 0:a.contact)&&(W(o.description)===""?null:o.description)===(a==null?void 0:a.description)};T.useEffect(()=>{a&&C({type:a.type||"",contact:a.contact||"",description:a.description||""})},[a,C]);const l=async o=>{if(!y())return new Promise((g,z)=>{j.mutateAsync({clientId:a.client_id,contactId:a.id,...o,description:W(o.description)===""?null:o.description}).then(()=>{u(),U("Contacto atualizado com sucesso!"),g()}).catch(X=>{if(X.error.code==="CLI-004")return n("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"}),z();u(),H("Erro ao atualizar contacto!"),z()})})},x=f("type","");return e.jsx(k,{mode:"form",title:"Editar Contacto",open:i,onClose:u,submitButtonText:"Editar Contacto",onSubmit:_(l),disabled:y(),children:e.jsx(M,{sx:{padding:3,paddingTop:1},children:e.jsxs(S,{container:!0,spacing:2,children:[e.jsx(S,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"type",control:m,render:({field:o})=>{var g;return e.jsx(V,{ref:o.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:o.value,onChange:o.onChange,error:!!r.type,helperText:(g=r.type)==null?void 0:g.message,inputRef:p})}})})}),e.jsx(S,{item:!0,xs:12,children:x==="E-mail"?e.jsx(v,{fullWidth:!0,children:e.jsx(D,{...h("contact"),label:"E-mail",error:!!r.contact,helperText:(b=r.contact)==null?void 0:b.message,InputLabelProps:{shrink:((t=f("contact"))==null?void 0:t.length)>0}})}):e.jsx(e.Fragment,{children:x==="Telefone"||x==="Telemóvel"?e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:m,render:({field:o})=>{var g;return e.jsx($,{...o,value:o.value||"+351",defaultCountry:"pt",label:x,variant:"outlined",fullWidth:!0,error:!!r.contact,helperText:(g=r.contact)==null?void 0:g.message,disableDropdown:!0})}})}):e.jsx(v,{fullWidth:!0,children:e.jsx(D,{...h("contact"),label:"Contacto",error:!!r.contact,helperText:(s=r.contact)==null?void 0:s.message,InputLabelProps:{shrink:((F=f("contact"))==null?void 0:F.length)>0}})})})}),e.jsx(S,{item:!0,xs:12,children:e.jsx(E,{name:"description",control:m,render:({field:o})=>e.jsx(q,{label:"Descrição",value:o.value,onChange:o.onChange})})})]})})})},ue=({client:a,isLoading:i,isError:u})=>{const m=!i&&!u,{role:h}=Y(),{deleteContactClient:_}=O(),[r,n]=T.useState({isOpen:!1,clientContact:null}),C=t=>{n({isOpen:!0,clientContact:t})},f=()=>{n({isOpen:!1,clientContact:null})},[j,p]=T.useState({isOpen:!1,clientContact:null}),y=t=>{p({isOpen:!0,clientContact:t})},l=()=>{p({isOpen:!1,clientContact:null})},x=()=>new Promise((t,s)=>{j.clientContact?_.mutateAsync({clientId:j.clientContact.client_id,contactId:j.clientContact.id}).then(()=>{l(),t()}).catch(()=>{l(),s()}):(l(),s())}),b=T.useMemo(()=>[{id:"type",label:"Tipo",align:"left",sortable:!0},{id:"contact",label:"Contacto",align:"left",sortable:!0,formatter:ie},{id:"created_by_user",visible:!1},{id:"created_at_datetime",label:"Criado por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.created_by_user?e.jsxs(e.Fragment,{children:[e.jsx(I,{alt:t.created_by_user.username,src:`${L}/users/${t.created_by_user.id}/avatar?size=80`,name:t.created_by_user.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(c,{variant:"p",component:"p",fontWeight:500,children:t.created_by_user.username}),e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:t.created_by_user.role})]})]}):e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(c,{variant:"p",component:"p",fontWeight:500,children:A(t.created_at_datetime)}),e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:B(t.created_at_datetime)})]})]})})},{id:"last_modified_by_user",visible:!1},{id:"last_modified_datetime",label:"Modificado pela última vez por",align:"left",sortable:!0,renderComponent:({row:t})=>e.jsx(e.Fragment,{children:t.last_modified_datetime?e.jsxs(d,{sx:{flexDirection:"row",gap:2},children:[e.jsx(d,{sx:{flexDirection:"row",justifyContent:"center",alignItems:"center",gap:1},children:t.last_modified_by_user?e.jsxs(e.Fragment,{children:[e.jsx(I,{alt:t.last_modified_by_user.username,src:`${L}/users/${t.last_modified_by_user.id}/avatar?size=80`,name:t.last_modified_by_user.username}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(c,{variant:"p",component:"p",fontWeight:500,children:t.last_modified_by_user.username}),e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:t.last_modified_by_user.role})]})]}):e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:"Utilizador removido"})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsxs(d,{sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[e.jsx(c,{variant:"p",component:"p",fontWeight:500,children:A(t.last_modified_datetime)}),e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:B(t.last_modified_datetime)})]})]}):e.jsx(c,{variant:"p",component:"p",color:"var(--outline)",children:"Ainda não foi modificado"})})},{id:"moreOptions",align:"right",sortable:!1,renderComponent:({row:t})=>e.jsx(Z,{mode:"custom",customButton:e.jsx(K,{title:"Mais opções",sx:{margin:-1},children:e.jsx(Q,{children:e.jsx(le,{})})}),children:e.jsx(ee,{buttons:[{label:"Editar",icon:e.jsx(ce,{fontSize:"small"}),onClick:()=>C(t)},...h!=="Funcionário"?[{label:"Eliminar",icon:e.jsx(te,{fontSize:"small",color:"error"}),color:"error",divider:!0,onClick:()=>y(t)}]:[]]})})}],[]);return e.jsxs(d,{children:[e.jsx(J,{title:"Contactos",description:"Contactos do cliente",icon:e.jsx(G,{})}),e.jsx(ae,{isLoading:!m,LoadingComponent:e.jsx(oe,{mode:"datatable"}),LoadedComponent:e.jsx(M,{sx:{margin:3,border:"1px solid var(--elevation-level5)",borderRadius:2,overflow:"hidden"},children:e.jsx(re,{mode:"datatable",data:m?a[0].contacts:[],columns:b})})}),e.jsx(w,{sx:{borderColor:"var(--elevation-level5)",borderWidth:1}}),e.jsx(de,{clientContact:r.clientContact,open:r.isOpen,onClose:f}),e.jsx(k,{mode:"delete",title:"Eliminar Contacto",open:j.isOpen,onClose:l,onSubmit:x,description:"Tem a certeza que deseja eliminar este contacto?",subDescription:"Ao eliminar este contacto, os dados serão removidos de forma permanente."})]})},me=({client:a,isLoading:i,isError:u})=>{var x,b;const m=!i&&!u,{control:h,register:_,handleSubmit:r,formState:{errors:n},setError:C,watch:f,reset:j}=P({resolver:R(N)}),{addNewContactClient:p}=O(),y=async t=>{m&&await p.mutateAsync({clientId:a[0].id,...t,description:W(t.description)===""?null:t.description}).then(()=>{j(),U("Contacto adicionado com sucesso!")}).catch(s=>{if(s.error.code==="CLI-002"){C("contact",{type:"manual",message:"Já existe um contacto com o mesmo tipo e valor para este cliente"});return}H("Erro ao adicionar contacto!")})},l=f("type","");return e.jsxs(d,{children:[e.jsx(J,{title:"Contacto",description:"Adicionar novo contacto ao cliente",icon:e.jsx(G,{})}),e.jsx("form",{onSubmit:r(y),children:e.jsxs(d,{sx:{padding:3,gap:2},children:[e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"type",control:h,defaultValue:"",render:({field:t})=>{var s;return e.jsx(V,{ref:t.ref,label:"Tipo",data:["","E-mail","Telefone","Telemóvel","Outro"],value:t.value,onChange:t.onChange,error:!!n.type,helperText:(s=n.type)==null?void 0:s.message})}})}),l==="E-mail"?e.jsx(v,{fullWidth:!0,children:e.jsx(D,{..._("contact"),label:"E-mail",error:!!n.contact,helperText:(x=n.contact)==null?void 0:x.message})}):e.jsx(e.Fragment,{children:l==="Telefone"||l==="Telemóvel"?e.jsx(v,{fullWidth:!0,children:e.jsx(E,{name:"contact",control:h,defaultValue:"+351",render:({field:t})=>{var s;return e.jsx($,{...t,value:t.value||"+351",defaultCountry:"pt",label:l,variant:"outlined",fullWidth:!0,error:!!n.contact,helperText:(s=n.contact)==null?void 0:s.message,disableDropdown:!0})}})}):e.jsx(v,{fullWidth:!0,children:e.jsx(D,{..._("contact"),label:"Contacto",error:!!n.contact,helperText:(b=n.contact)==null?void 0:b.message})})}),e.jsx(E,{name:"description",control:h,defaultValue:"",render:({field:t})=>e.jsx(q,{label:"Descrição",value:t.value,onChange:t.onChange})}),e.jsx(M,{sx:{marginLeft:"auto",marginTop:1},children:e.jsx(ne,{loading:p.isPending,type:"submit",variant:"contained",disabled:!m,children:"Adicionar Contacto"})})]})})]})},Ce=({client:a,isLoading:i,isError:u})=>e.jsxs(se,{elevation:1,children:[e.jsx(ue,{client:a,isLoading:i,isError:u}),e.jsx(me,{client:a,isLoading:i,isError:u})]});export{Ce as default};
